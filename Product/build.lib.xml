<?xml version="1.0" encoding="utf-8"?>
<project name="build.lib" default="none">
  <property environment="env"/>
  <property name="project.dir" location="." />
  <basename file="${project.dir}" property="project.name" />

  <property name="ProductDirectory" location='.' id="proddir"/>

  <import file="build.properties.xml"/>

  <import file="Properties.build.xml"/>

  <import file="build/checkstyle/checkstyle.targets.xml"/>
  <property name="libs.CopyLibs.classpath" value="${ant.home}/extra/org-netbeans-modules-java-j2seproject-copylibstask.jar" />

  <import file="Install/deploy.xml"/>

  <path id="ant.contrib.task.classpath">
    <pathelement location="${ant.home}/lib/ant-contrib-1.0b3.jar"/>
    <pathelement location="${ant.home}/lib/ivy-2.1.0-rc1.jar"/>
    <pathelement location="${ant.home}/lib/bcel-5.1.jar"/>
    <pathelement location="${ant.home}/lib/commons-httpclient-3.0.1.jar"/>
    <pathelement location="${ant.home}/lib/commons-logging-1.0.4.jar"/>
  </path>

  <taskdef name="for" classname="net.sf.antcontrib.logic.ForTask">
    <classpath refid="ant.contrib.task.classpath"/>
  </taskdef>

  <taskdef name="if" classname="net.sf.antcontrib.logic.IfTask">
    <classpath refid="ant.contrib.task.classpath"/>
  </taskdef>

  <taskdef name="var" classname="net.sf.antcontrib.property.Variable">
    <classpath refid="ant.contrib.task.classpath"/>
  </taskdef>

  <taskdef name="outofdate" classname="net.sf.antcontrib.logic.OutOfDate">
    <classpath refid="ant.contrib.task.classpath"/>
  </taskdef>

  <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask">
    <classpath>
      <pathelement location="${ant.home}/lib/xmltask-v1.15.1.jar"/>
    </classpath>
  </taskdef>

  <macrodef name="call">
    <attribute name="target"/>
    <attribute name="if" default="true"/>
    <sequential>
      <if>
        <and>
          <istrue value="@{if}" />
          <isfalse value="@{unless}" />
        </and>
        <then>
          <runtarget target="@{target}"/>
        </then>
      </if>
    </sequential>
  </macrodef>

  <target name="create.deploy.list.xml">
    <xmltask dest="${deploy.application.list.file.path}" outputter="simple:3"> 
      <insert path="/"> 
        <![CDATA[ 
			  <applications>
			  <wars/>
			  <shared/>
			  <ejbs/>
			  </applications>
			  ]]>
      </insert>  
    </xmltask> 
  </target>

  <target name="addentry.deploy.list.xml">
    <echo message="Attempting to add entry ${project.name} to ${deploy.application.list.file.path}." />
    <switch value="${deploy.type}">
      <case value="war">
        <var name="deploy.list.entry.xpath" value="/applications/wars"/>
        <var name="deploy.list.entry" value="&lt;war&gt;&lt;name&gt;${project.name}&lt;/name&gt;&lt;/war&gt;"/>
        <runtarget target="insert.entry.to.deploy.app.list"/>
      </case>
      <case value="shared">
        <var name="deploy.list.entry.xpath" value="/applications/shared"/>
        <var name="deploy.list.entry" value="&lt;lib&gt;&lt;name&gt;${project.name}&lt;/name&gt;&lt;/lib&gt;"/>
        <runtarget target="insert.entry.to.deploy.app.list"/>       
      </case>
      <case value="ejb">
        <var name="deploy.list.entry.xpath" value="/applications/ejbs"/>
        <var name="deploy.list.entry" value="&lt;ejb&gt;&lt;name&gt;${project.name}&lt;/name&gt;&lt;/ejb&gt;"/>
        <runtarget target="insert.entry.to.deploy.app.list"/>
      </case>
      <default>
        <fail message="Deploy type ${deploy.type} is not supported."/>
      </default>
    </switch>
  </target>
  
  <target name="insert.entry.to.deploy.app.list">
    <xmltask  source="${deploy.application.list.file.path}" dest="${deploy.application.list.file.path}" outputter="simple:3">
      <insert path="${deploy.list.entry.xpath}" xml="${deploy.list.entry}"/>
    </xmltask>
  </target>

  <target name="copy.deployable.artifacts">
    <property file="${project.dir}/nbproject/project.properties"/>
    <switch value="${deploy.type}">
      <case value="war">
        <property name="dist.file" value="${project.dir}/${dist.war}"/>
      </case>
      <default>
        <condition property="dist.file" value="${project.dir}/${sedeployment.jar}" else="${project.dir}/${dist.jar}">
          <isset property="sedeployment.jar" />
        </condition>
      </default>
    </switch>

    <echo message="${dist.file}"/>
    <call target="addentry.deploy.list.xml" if="${deploy.isDeployable}"/>
    <call target="copy.artifacts.to.development" if="${deploy.isDeployable}"/>
  </target>

  <target name="deploy">
    <antcall target="create.deploy.list.xml"/>
    <call target="copy.deployable.artifacts" />
    <call target="deploy.to.production"/>
  </target>

  <target name="undeploy">
    <property file="${project.dir}/nbproject/project.properties"/>
    <switch value="${deploy.type}">
      <case value="war">
        <property name="dist.file" value="${project.dir}/${dist.war}"/>
      </case>
      <default>
        <condition property="dist.file" value="${project.dir}/${sedeployment.jar}" else="${project.dir}/${dist.jar}">
          <isset property="sedeployment.jar" />
        </condition>
      </default>
    </switch>

    <call target="undeploy.from.development" if="${deploy.isDeployable}"/>
  </target>

  <target name="checkstyle">
    <call target="checkstyle.style"/>
  </target>

  <!-- 
  ***** Properties used as params to this target *****
  <property name="target-to-call" value=""/>
  -->
  <target name="call-target-in-isolation-if-out-of-date">
    <property location="." name="project-to-build" />
    <echo message="project-to-build=${project-to-build}"/>
    <property name="target-to-call" value="dist" />
    <property name="base" value="${project-to-build}/lib" />
    <property file="${project-to-build}/lib/nblibraries.properties" />
    <property file="${project-to-build}/nbproject/project.properties" />
    <antcall target="build-project-if-out-of-date" />
  </target>

  <target name="clean-gen" if="is-gen-outofdate">
    <echo message="Cleaning generated code..."/>
    <delete dir="${build.generated.dir}"/>
  </target>

  <target name="clean-gen-if-out-of-date">
    <condition property="dist.file" value="${sedeployment.jar}" else="${dist.jar}">
      <isset property="sedeployment.jar" />
    </condition>

    <property name="current-project" location="."/>

    <echo message="Looking to see if ${current-project} generated code should be rebuilt."/>
    <echo message="Checking:"/>
    <echo message="${current-project}/${source.root}/**/*.wsdl"/>
    <echo message="${current-project}/${source.root}/**/*.xsd"/>
    <echo message="against:"/>
    <echo message="${current-project}/${dist.file}"/>

    <outofdate verbose="true" property="is-gen-outofdate">
      <sourcefiles>
        <fileset dir="${current-project}" casesensitive="no">
          <patternset>
            <include name="${source.root}/**/*.wsdl"/>
            <include name="${source.root}/**/*.xsd"/>
          </patternset>
        </fileset>
      </sourcefiles>
      <targetfiles path="${current-project}/${dist.file}"/>
    </outofdate>

    <echo message="It is ${is-gen-outofdate} that the generated code for the following is outofdate '${current-project}'."/>

    <antcall target="clean-gen"/>
  </target>

  <!-- 
  ***** Properties used as params to this target *****
  <property name="project-to-build" value=""/>
  <property name="target-to-call" value=""/>
  -->
  <target name="build-project-if-out-of-date" >
    <condition property="dist.file" value="${sedeployment.jar}" else="${dist.jar}">
      <isset property="sedeployment.jar" />
    </condition>

    <echo message="Looking to see if ${project-to-build} should be built."/>
    <echo message="Checking:"/>
    <echo message="${project-to-build}/${source.root}/**/*"/>
    <echo message="against:"/>
    <echo message="${project-to-build}/${dist.file}"/>
    <echo message="${javac.classpath}"/>

    <if>
      <isset property="javac.classpath" />
      <then>

        <var name="javac.classpath.exists" value="true"/>
        <for delimiter=":;"  list="${javac.classpath}" param="jar.file">
          <sequential>
            <if>
              <length string="@{jar.file}" trim="true" length="1" />
              <then>
              </then>
              <else>

                <available property="@{jar.file}.exists" file="@{jar.file}"/>

                <if>
                  <isset property="@{jar.file}.exists" />
                  <then>
                    <echo message="It is true that this file exists: @{jar.file}."/>
                  </then>
                  <else>
                    <echo message="It is false that this file exists: @{jar.file}."/>
                    <var name="javac.classpath.exists" value="false"/>
                  </else>
                </if>
              </else>
            </if>
          </sequential>
        </for>

        <echo message="All the files in javac.classpath exist: ${javac.classpath.exists}."/>
      </then>
      <else>
        <property name="javac.classpath" value=""/>
        <var name="javac.classpath.exists" value="true"/>
        <echo message="javac.classpath was not set, setting it to ''."/>
      </else>
    </if>

    <if>
      <equals arg1="${javac.classpath.exists}" arg2="true" />
      <then>
        <outofdate verbose="true" force="${outofdate.force}" property="need.build">
          <sourcefiles>
            <pathelement path="${javac.classpath}"/>
            <fileset dir="${project-to-build}" casesensitive="no">
              <patternset>
                <include name="${source.root}/**/*"/>
              </patternset>
            </fileset>
          </sourcefiles>
          <targetfiles path="${project-to-build}/${dist.file}"/>
        </outofdate>
      </then>
      <else>
        <property name="need.build" value="true"/>
      </else>
    </if>

    <if>
      <equals arg1="${need.build}" arg2="true" />
      <then>
        <echo message="Building ${project-to-build}"/>
        <echo message="Calling target ${target-to-call}"/>
        <ant
            dir="${project-to-build}"
            target="${target-to-call}"
            inheritall="false"
            antfile="${project-to-build}/build.xml"
            />
      </then>
      <else>
        <echo message="No need to build the following project, it is already uptodate: ${project-to-build}"/>
      </else>
    </if>
  </target>
</project>
