<?xml version="1.0" encoding="UTF-8"?>
<process
    name="NhincComponentInternalSubDiscovery201301Orch"
    targetNamespace="urn:gov:hhs:fha:nhinc:gateway:nhincinternalorchbpel:nhinccomponentinternalsubdiscovery201301"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="urn:gov:hhs:fha:nhinc:gateway:nhincinternalorchbpel:nhinccomponentinternalsubdiscovery201301" 
    xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" 
    xmlns:hl7="urn:hl7-org:v3" 
    xmlns:propacc="urn:gov:hhs:fha:nhinc:common:propertyaccess" 
    xmlns:ncpc="urn:gov:hhs:fha:nhinc:common:patientcorrelationfacade" 
    xmlns:nccommon="urn:gov:hhs:fha:nhinc:common:nhinccommon" 
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" 
    xmlns:conninfo="urn:gov:hhs:fha:nhinc:common:connectionmanagerinfo" xmlns:ns0="urn:gov:hhs:fha:nhinc:common:eventcommon" xmlns:ns1="urn:gov:hhs:fha:nhinc:common:policyenginedte" xmlns:ns2="urn:oasis:names:tc:xacml:2.0:context:schema:os" xmlns:ns3="urn:gov:hhs:fha:nhinc:common:nhinccommonadapter">
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" location="Interfaces/wsdl/NhincComponentInternalSubDiscovery201301Orch.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" location="Interfaces/wsdl/NhincComponentPropAccessor.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:adaptermpi" location="Interfaces/wsdl/AdapterMpi.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" location="Interfaces/wsdl/NhincComponentPatientCorrelationFacade.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" location="Interfaces/wsdl/NhincComponentSubDiscTransforms.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" location="Interfaces/wsdl/NhincProxySubjectDiscovery.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" location="Interfaces/wsdl/NhincComponentConnectionManager.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" location="Interfaces/wsdl/NhincComponentInternalPolicyEngineFacade.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="PolicyEngineFacadePL" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" partnerLinkType="tns:NhincComponentInternalPolicyEngineFacade" partnerRole="NhincComponentInternalPolicyEngineFacadePortTypeRole"/>
        <partnerLink name="PropAccessorPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" partnerLinkType="tns:NhincComponentPropAccessor" partnerRole="NhincComponentPropAccessorPortTypeRole"/>
        <partnerLink name="SubDiscDataTransformsPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" partnerLinkType="tns:NhincComponentSubDiscTransforms" partnerRole="NhincComponentSubDiscTransformsPortTypeRole"/>
        <partnerLink name="ConnectionMgrPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" partnerLinkType="tns:NhincComponentConnectionManager" partnerRole="NhincComponentConnectionManagerPortTypeRole"/>
        <partnerLink name="MpiPL" xmlns:tns="urn:gov:hhs:fha:nhinc:adaptermpi" partnerLinkType="tns:AdapterMpiService" partnerRole="AdapterMpiPortTypeRole"/>
        <partnerLink name="PatientCorrelationPL" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" partnerLinkType="tns:PatientCorrelationFacadePartnerLinkType" partnerRole="PatientCorrelationPortTypeRole"/>
        <partnerLink name="NhincProxySubjectDiscoveryPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" partnerLinkType="tns:NhincProxySubjectDiscovery" partnerRole="NhincProxySubjectDiscoveryPortTypeRole"/>
        <partnerLink name="NhincComponentInternalSubDiscOrchPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" partnerLinkType="tns:NhincComponentInternalSubDiscovery201301Orch" myRole="NhincComponentInternalSubDiscovery201301OrchPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="AnnounceNewPatientOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" messageType="tns:AnnounceNewPatientResponseMessage"/>
        <variable name="AnnounceNewPatientIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" messageType="tns:AnnounceNewPatientRequestMessage"/>
    </variables>
    <sequence>
        <receive name="ReceiveNhincComponentInternalSubDiscOrch" createInstance="yes" partnerLink="NhincComponentInternalSubDiscOrchPL" operation="AnnounceNewPatient" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" portType="tns:NhincComponentInternalSubDiscovery201301OrchPortType" variable="AnnounceNewPatientIn"/>
        <scope name="NhincComponentInternalSubDiscOrchScope">
            <variables>
                <variable name="CheckPolicySubjectAddedOut" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" messageType="tns:CheckPolicyResponseMessage"/>
                <variable name="CheckPolicySubjectAddedIn" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" messageType="tns:CheckPolicySubjectAddedRequestMessage"/>
                <variable name="StoreAAToHCIDOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:StoreAssigningAuthorityToHomeCommunityMappingResponseMessage"/>
                <variable name="StoreAAToHCIDIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:StoreAssigningAuthorityToHomeCommunityMappingRequestMessage"/>
                <variable name="GetMpiEndpointIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameRequestMessage"/>
                <variable name="GetMpiEndPointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameResponseMessage"/>
                <variable name="PIX201302Out" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201302UVProxyResponseMessage"/>
                <variable name="PIX201302In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201302UVProxyRequestMessage"/>
                <variable name="Create201302Out" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:Create201302ResponseMessage"/>
                <variable name="Create201302In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:Create201302RequestMessage"/>
                <variable name="GetHcidPropertyOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyResponseMessage"/>
                <variable name="GetHcidPropertyIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyRequestMessage"/>
                <variable name="Create201305Out" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:Create201305ResponseMessage"/>
                <variable name="Create201305In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:Create201305RequestMessage"/>
                <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckResponseMessage"/>
                <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckRequestMessage"/>
                <variable name="AddPatientCorrelationOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:AddPatientCorrelationResponseMessage"/>
                <variable name="AddPatientCorrelationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:AddPatientCorrelationRequestMessage"/>
                <variable name="FindCandidatesOut" xmlns:tns="urn:gov:hhs:fha:nhinc:adaptermpi" messageType="tns:FindCandidatesResponse"/>
                <variable name="FindCandidatesIn" xmlns:tns="urn:gov:hhs:fha:nhinc:adaptermpi" messageType="tns:FindCandidatesRequest"/>
            </variables>
            <faultHandlers>
                <catch faultName="sxeh:systemFault" faultVariable="systemFaultVar" faultMessageType="sxeh:faultMessage">
                    <sequence name="SystemFaultSeq">
                        <assign name="AssignFaultAckDte">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <bpel:from>'NhinComponentInternalSubDiscovery201301Orch.bpel - A system fault was encounterd processing a 201301 message. Fault detials follow...'</bpel:from>
                                </sxt:log>
                                <sxt:log level="warning" location="onStart">
                                    <bpel:from variable="systemFaultVar"/>
                                </sxt:log>
                            </sxt:trace>
                            <copy>
                                <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:id</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                            </copy>
                            <copy>
                                <from>'Error - Internal Gateway Error'</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                            </copy>
                            <copy>
                                <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                            </copy>
                            <copy>
                                <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeFaultAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                        <assign name="AssignFaultInfo">
                            <copy>
                                <from variable="CreateAckOut" part="CreateAckResponse"/>
                                <to variable="AnnounceNewPatientOut" part="AnnounceNewPatientResponse"/>
                            </copy>
                        </assign>
                        <reply name="ReplyNhincComponentInternalSubDiscOrchFault" partnerLink="NhincComponentInternalSubDiscOrchPL" operation="AnnounceNewPatient" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" portType="tns:NhincComponentInternalSubDiscovery201301OrchPortType" variable="AnnounceNewPatientOut"/>
                        <exit name="ExitAfterFaultReturn"/>
                    </sequence>
                </catch>
            </faultHandlers>
            <sequence name="NhincComponentInternalSubDiscOrchSequence">
                <assign name="AssignStoreAAToHcid">
                    <copy>
                        <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@root)</from>
                        <to>$StoreAAToHCIDIn.StoreAssigningAuthorityToHomeCommunityMappingRequest/conninfo:AssigningAuthority/nccommon:assigningAuthorityId</to>
                    </copy>
                    <copy>
                        <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                        <to>$StoreAAToHCIDIn.StoreAssigningAuthorityToHomeCommunityMappingRequest/conninfo:HomeCommunity/nccommon:homeCommunityId</to>
                    </copy>
                </assign>
                <invoke name="InvokeStoreAAToHcid" partnerLink="ConnectionMgrPL" operation="StoreAssigningAuthorityToHomeCommunityMapping" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="StoreAAToHCIDIn" outputVariable="StoreAAToHCIDOut"/>
                <assign name="AssignGetLocalHomeCommunity">
                    <copy>
                        <from>'gateway'</from>
                        <to>$GetHcidPropertyIn.GetPropertyRequest/propacc:propertyFile</to>
                    </copy>
                    <copy>
                        <from>'localHomeCommunityId'</from>
                        <to>$GetHcidPropertyIn.GetPropertyRequest/propacc:propertyName</to>
                    </copy>
                </assign>
                <invoke name="InvokeGetLocalHomeCommunity" partnerLink="PropAccessorPL" operation="GetProperty" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" portType="tns:NhincComponentPropAccessorPortType" inputVariable="GetHcidPropertyIn" outputVariable="GetHcidPropertyOut"/>
                <assign name="AssignCreate201305">
                    <copy>
                        <from>$GetHcidPropertyOut.GetPropertyResponse/propacc:propertyValue</from>
                        <to>$Create201305In.Create201305Request/hl7:senderOID</to>
                    </copy>
                    <copy>
                        <from>$GetHcidPropertyOut.GetPropertyResponse/propacc:propertyValue</from>
                        <to>$Create201305In.Create201305Request/hl7:receiverOID</to>
                    </copy>
                    <copy>
                        <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient</from>
                        <to>$Create201305In.Create201305Request/hl7:PRPA201301Patient</to>
                    </copy>
                </assign>
                <invoke name="InvokeCreate201305" partnerLink="SubDiscDataTransformsPL" operation="Create201305" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="Create201305In" outputVariable="Create201305Out"/>
                <assign name="AssignGetMpiEndpoint">
                    <copy>
                        <from>$GetHcidPropertyOut.GetPropertyResponse/propacc:propertyValue</from>
                        <to>$GetMpiEndpointIn.GetConnectionInfoEndpointByServiceNameRequest/conninfo:homeCommunityWithServiceName/conninfo:homeCommunity/nccommon:homeCommunityId</to>
                    </copy>
                    <copy>
                        <from>'mpi'</from>
                        <to>$GetMpiEndpointIn.GetConnectionInfoEndpointByServiceNameRequest/conninfo:homeCommunityWithServiceName/conninfo:serviceName</to>
                    </copy>
                </assign>
                <invoke name="InvokeGetMpiEndpoint" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpointByServiceName" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetMpiEndpointIn" outputVariable="GetMpiEndPointOut"/>
                <assign name="AssignMpi">
                    <copy>
                        <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:assertion</from>
                        <to>$FindCandidatesIn.FindCandidatesRequest/hl7:assertion</to>
                    </copy>
                    <copy>
                        <from variable="Create201305Out" part="Create201305Response"/>
                        <to>$FindCandidatesIn.FindCandidatesRequest/hl7:PRPA_IN201305UV</to>
                    </copy>
                    <copy>
                        <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetMpiEndPointOut.ConnectionInfoEndpoint/conninfo:serviceConnectionInfoEndpoints/conninfo:serviceConnectionInfoEndpoint/nccommon:EPR/nccommon:EndpointReference)</from>
                        <to partnerLink="MpiPL"/>
                    </copy>
                </assign>
                <invoke name="InvokeMpi" partnerLink="MpiPL" operation="FindCandidates" xmlns:tns="urn:gov:hhs:fha:nhinc:adaptermpi" portType="tns:AdapterMpiPortType" inputVariable="FindCandidatesIn" outputVariable="FindCandidatesOut">
                </invoke>
                <if name="IfPatientFound">
                    <condition>count($FindCandidatesOut.FindCandidatesResponse/hl7:controlActProcess) != 0</condition>
                    <sequence name="PatientFoundSeq">
                        <assign name="AssignCreate201302">
                            <copy>
                                <from>$FindCandidatesOut.FindCandidatesResponse/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient</from>
                                <to>$Create201302In.Create201302Request/hl7:PRPA201310Patient</to>
                            </copy>
                            <copy>
                                <from>string($FindCandidatesOut.FindCandidatesResponse/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                <to>$Create201302In.Create201302Request/hl7:senderOID</to>
                            </copy>
                            <copy>
                                <from>string($FindCandidatesOut.FindCandidatesResponse/hl7:sender/hl7:device/hl7:id/@root)</from>
                                <to>$Create201302In.Create201302Request/hl7:receiverOID</to>
                            </copy>
                            <copy>
                                <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@root)</from>
                                <to>$Create201302In.Create201302Request/hl7:remoteDeviceId</to>
                            </copy>
                            <copy>
                                <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension)</from>
                                <to>$Create201302In.Create201302Request/hl7:remotePatientId</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeCreate201302" partnerLink="SubDiscDataTransformsPL" operation="Create201302" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="Create201302In" outputVariable="Create201302Out"/>
                        <assign name="AssignCheckPolicy">
                            <copy>
                                <from>'Inbound'</from>
                                <to>$CheckPolicySubjectAddedIn.CheckPolicySubjectAddedRequest/ns0:direction</to>
                            </copy>
                            <copy>
                                <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:assertion</from>
                                <to>$CheckPolicySubjectAddedIn.CheckPolicySubjectAddedRequest/ns0:message/hl7:assertion</to>
                            </copy>
                            <copy>
                                <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                <to>$CheckPolicySubjectAddedIn.CheckPolicySubjectAddedRequest/ns0:sendingHomeCommunity/nccommon:homeCommunityId</to>
                            </copy>
                            <copy>
                                <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV</from>
                                <to>$CheckPolicySubjectAddedIn.CheckPolicySubjectAddedRequest/ns0:message/hl7:PRPA_IN201301UV</to>
                            </copy>
                        </assign>
                        <assign name="OverridePatientId">
                            <copy>
                                <from>$Create201302Out.Create201302Response/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id</from>
                                <to>$CheckPolicySubjectAddedIn.CheckPolicySubjectAddedRequest/ns0:message/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeCheckPolicy" partnerLink="PolicyEngineFacadePL" operation="CheckPolicySubjectAdded" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" portType="tns:NhincComponentInternalPolicyEngineFacadePortType" inputVariable="CheckPolicySubjectAddedIn" outputVariable="CheckPolicySubjectAddedOut"/>
                        <if name="IfPolicyValid">
                            <condition>'Permit' = $CheckPolicySubjectAddedOut.CheckPolicyResponse/ns3:response/ns2:Result/ns2:Decision</condition>
                            <sequence name="PolicyTrueSequence">
                                <assign name="AssignPatientCorrelation">
                                    <copy>
                                            <from>string($FindCandidatesOut.FindCandidatesResponse/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@root)</from>
                                                <to>$AddPatientCorrelationIn.AddPatientCorrelationRequest/ncpc:QualifiedPatientIdentifier[1]/nccommon:AssigningAuthorityIdentifier
                                    <sxed:editor>
                                                            <sxed:predicate path="$AddPatientCorrelationIn.AddPatientCorrelationRequest/ncpc:QualifiedPatientIdentifier[1]" source="to"/>
                                                        </sxed:editor>
                                                </to>
                                        </copy>
                                        <copy>
                                            <from>string($FindCandidatesOut.FindCandidatesResponse/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension)</from>
                                                <to>$AddPatientCorrelationIn.AddPatientCorrelationRequest/ncpc:QualifiedPatientIdentifier[1]/nccommon:SubjectIdentifier</to>
                                        </copy>
                                        <copy>
                                            <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@root)</from>
                                                <to>$AddPatientCorrelationIn.AddPatientCorrelationRequest/ncpc:QualifiedPatientIdentifier[2]/nccommon:AssigningAuthorityIdentifier</to>
                                        </copy>
                                        <copy>
                                            <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension)</from>
                                                <to>$AddPatientCorrelationIn.AddPatientCorrelationRequest/ncpc:QualifiedPatientIdentifier[2]/nccommon:SubjectIdentifier</to>
                                        </copy>
                                </assign>
                                <invoke name="InvokePatientCorrelation" partnerLink="PatientCorrelationPL" operation="AddPatientCorrelation" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" portType="tns:PatientCorrelationFacadePortType" inputVariable="AddPatientCorrelationIn" outputVariable="AddPatientCorrelationOut"/>
                                <assign name="AssignSendToProxy">
                                    <copy>
                                        <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:assertion</from>
                                        <to>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion</to>
                                    </copy>
                                    <copy>
                                        <from variable="Create201302Out" part="Create201302Response"/>
                                        <to>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV</to>
                                    </copy>
                                    <copy>
                                        <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root</from>
                                        <to>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV/hl7:receiver/hl7:device/hl7:id/@root</to>
                                    </copy>
                                    <copy>
                                        <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:nhinTargetSystem/nccommon:homeCommunity/nccommon:homeCommunityId</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeSendToProxy" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201302UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" inputVariable="PIX201302In" outputVariable="PIX201302Out"/>
                                <assign name="AssignSuccessAckDte">
                                    <copy>
                                        <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:id</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                    </copy>
                                    <copy>
                                        <from>'Success'</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                    </copy>
                                    <copy>
                                        <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeSuccessAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                <assign name="AssignSuccessResp">
                                    <copy>
                                        <from variable="CreateAckOut" part="CreateAckResponse"/>
                                        <to variable="AnnounceNewPatientOut" part="AnnounceNewPatientResponse"/>
                                    </copy>
                                </assign>
                            </sequence>
                            <else>
                                <sequence name="InvalidPolicySeq">
                                    <assign name="AssignPolicyInvalidAckDte">
                                        <copy>
                                            <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:id</from>
                                            <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                        </copy>
                                        <copy>
                                            <from>'Error - Policy Check Failed'</from>
                                            <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                        </copy>
                                        <copy>
                                            <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                            <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                        </copy>
                                        <copy>
                                            <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                            <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                        </copy>
                                    </assign>
                                    <invoke name="InvokePolicyInvalidAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                    <assign name="AssignPolicyInvalidResp">
                                        <copy>
                                            <from variable="CreateAckOut" part="CreateAckResponse"/>
                                            <to variable="AnnounceNewPatientOut" part="AnnounceNewPatientResponse"/>
                                        </copy>
                                    </assign>
                                </sequence>
                            </else>
                        </if>
                    </sequence>
                    <else>
                        <sequence name="PatientNotFoundSeq">
                            <assign name="AssignPatientNotFoundAckDte">
                                <copy>
                                    <from>$AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:id</from>
                                    <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                </copy>
                                <copy>
                                    <from>'Warning - Patient Not Found'</from>
                                    <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                </copy>
                                <copy>
                                    <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                    <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                </copy>
                                <copy>
                                    <from>string($AnnounceNewPatientIn.AnnounceNewPatientRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                    <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                </copy>
                            </assign>
                            <invoke name="InvokePatientNotFoundAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                            <assign name="AssignPatientNotFoundResp">
                                <copy>
                                    <from variable="CreateAckOut" part="CreateAckResponse"/>
                                    <to variable="AnnounceNewPatientOut" part="AnnounceNewPatientResponse"/>
                                </copy>
                            </assign>
                        </sequence>
                    </else>
                </if>
            </sequence>
        </scope>
        <reply name="ReplyNhincComponentInternalSubDiscOrch" partnerLink="NhincComponentInternalSubDiscOrchPL" operation="AnnounceNewPatient" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalsubdiscovery201301orch" portType="tns:NhincComponentInternalSubDiscovery201301OrchPortType" variable="AnnounceNewPatientOut"/>
    </sequence>
</process>
