<?xml version="1.0" encoding="UTF-8"?>
<process
    name="NhinProxySubjectDiscovery"
    targetNamespace="urn:gov:hhs:fha:nhinc:gateway:nhincproxybpel:nhinproxysubjectdiscovery"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="urn:gov:hhs:fha:nhinc:gateway:nhincproxybpel:nhinproxysubjectdiscovery"
    xmlns:hl7="urn:hl7-org:v3"
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" 
    xmlns:conninfo="urn:gov:hhs:fha:nhinc:common:connectionmanagerinfo" 
    xmlns:nccommon="urn:gov:hhs:fha:nhinc:common:nhinccommon" 
    xmlns:soapaddr04="http://schemas.xmlsoap.org/ws/2004/08/addressing" 
    xmlns:pixv3="urn:ihe:iti:pixv3:2007" xmlns:audit="urn:gov:hhs:fha:nhinc:common:auditlog">
    <import namespace="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" location="Interfaces/wsdl/NhincProxySubjectDiscovery.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" location="Interfaces/wsdl/NhincComponentSubDiscTransforms.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/NhinSubjectDiscoveryWrapper" location="NhinSubjectDiscoveryWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:ihe:iti:pixv3:2007" location="Interfaces/wsdl/NhinSubjectDiscovery.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" location="Interfaces/wsdl/NhincComponentConnectionManager.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" location="Interfaces/wsdl/NhincComponentInternalAuditRepository.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="SubDiscDataTransformsPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" partnerLinkType="tns:NhincComponentSubDiscTransforms" partnerRole="NhincComponentSubDiscTransformsPortTypeRole"/>
        <partnerLink name="ConnectionMgrPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" partnerLinkType="tns:NhincComponentConnectionManager" partnerRole="NhincComponentConnectionManagerPortTypeRole"/>
        <partnerLink name="NhinSubjectDiscoveryPL" xmlns:tns="http://enterprise.netbeans.org/bpel/NhinSubjectDiscoveryWrapper" partnerLinkType="tns:PIXConsumer_LinkType" partnerRole="PIXConsumer_Role"/>
        <partnerLink name="AuditRepositoryPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" partnerLinkType="tns:NhincComponentInternalAuditRepository" partnerRole="NhincComponentInternalAuditRepositoryPortTypeRole"/>
        <partnerLink name="NhincProxySubjectDiscoveryPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" partnerLinkType="tns:NhincProxySubjectDiscovery" myRole="NhincProxySubjectDiscoveryPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="PIX201309In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201309UVProxyRequestMessage"/>
        <variable name="PIX201304In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201304UVProxyRequestMessage"/>
        <variable name="PIX201303In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201303UVProxyRequestMessage"/>
        <variable name="PIX201302In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201302UVProxyRequestMessage"/>
        <variable name="PIX201301In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" messageType="tns:PIXConsumer_PRPA_IN201301UVProxyRequestMessage"/>
    </variables>
    <sequence>
        <pick name="HandleSubDiscoveryMessageSeq" createInstance="yes">
            <onMessage partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201301UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201301In">
                <scope name="Handle201301Scope">
                    <variables>
                        <variable name="GetConnectionInfoEndpontFromNhinTargetIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetRequestMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogNhinSubjectDiscoveryAckRequestMessage"/>
                        <variable name="LogSubjectAddedOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogSubjectAddedIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogSubjectAddedRequestMessage"/>
                        <variable name="PIX201301OutgoingOut" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:MCCI_IN000002UV01_Message"/>
                        <variable name="PIX201301OutgoingIn" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201301UV_Message"/>
                        <variable name="GetConnectionInfoEndpointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetResponseMessage"/>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="PIX201301Out" messageType="tns:PIXConsumer_PRPA_IN201301UVProxyResponseMessage"/>
                    </variables>
                    <faultHandlers>
                        <catch faultName="sxeh:systemFault" faultVariable="systemFault201301Var" faultMessageType="sxeh:faultMessage">
                            <sequence name="SystemFault201301Seq">
                                <assign name="AssignFaultAckDte">
                                    <sxt:trace>
                                        <sxt:log level="info" location="onStart">
                                            <bpel:from>'NhinProxySubjectDiscovery.bpel - A system fault was encounterd processing a 201301 message. Fault detials follow...'</bpel:from>
                                        </sxt:log>
                                        <sxt:log level="warning" location="onStart">
                                            <bpel:from variable="systemFault201301Var"/>
                                        </sxt:log>
                                    </sxt:trace>
                                    <copy>
                                        <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV/hl7:id</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                    </copy>
                                    <copy>
                                        <from>'Error - Internal Gateway Error: Message Not Sent'</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeFaultAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                <assign name="Assign201301FaultInfo">
                                    <copy>
                                        <from variable="CreateAckOut" part="CreateAckResponse"/>
                                        <to variable="PIX201301Out" part="PIXConsumer_PRPA_IN201301UVProxyResponse"/>
                                    </copy>
                                </assign>
                                <reply name="ReplyNhinSubDisc201301Fault" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201301UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201301Out"/>
                                <exit name="ExitAfter201301FaultReturn"/>
                            </sequence>
                        </catch>
                    </faultHandlers>
                    <sequence name="Send201301Seq">
                        <assign name="AssignAudit201301">
                            <copy>
                                <from>'Outbound'</from>
                                <to>$LogSubjectAddedIn.LogSubjectAddedRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogSubjectAddedIn.LogSubjectAddedRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV</from>
                                <to>$LogSubjectAddedIn.LogSubjectAddedRequest/audit:message/hl7:PRPA_IN201301UV</to>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion</from>
                                <to>$LogSubjectAddedIn.LogSubjectAddedRequest/audit:message/hl7:assertion</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201301" partnerLink="AuditRepositoryPL" operation="LogSubjectAdded" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogSubjectAddedIn" outputVariable="LogSubjectAddedOut"/>
                        <assign name="AssignGetNhinConnectionInfo">
                            <copy>
                                <from>'subjectdiscovery'</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:serviceName</to>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:nhinTargetSystem</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:NhinTargetSystem</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeGetNhinConnectionInfo" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpontFromNhinTarget" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpontFromNhinTargetIn" outputVariable="GetConnectionInfoEndpointOut"/>
                        <assign name="AssignAssertion">
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:claimFormRef</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:contentReference"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:expirationDate</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:expirationDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystem</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:purposeForUseCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:purposeForUseCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:displayName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:purposeForUseDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:code</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:purposeForUseRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:dateOfSignature</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:signDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:givenName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userFirstName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:familyName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userLastName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:secondNameOrInitials</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userMiddleName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:userName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:org/nccommon:name</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userOrganization"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:code</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:displayName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userRoleCodeDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystem</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userRoleCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:userRoleCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>'subjectDiscovery'</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:action"/>
                            </copy>
                            <copy>
                                <from>string($GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference/soapaddr04:Address)</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:resource"/>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion/nccommon:claimFormRaw</from>
                                <to variable="PIX201301OutgoingIn" property="pixv3:content"/>
                            </copy>
                        </assign>
                        <assign name="AssignSendToGateway">
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV</from>
                                <to variable="PIX201301OutgoingIn" part="Body"/>
                            </copy>
                            <copy>
                                <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference)</from>
                                <to partnerLink="NhinSubjectDiscoveryPL"/>
                            </copy>
                        </assign>
                        <invoke name="InvokeSendToGateway" partnerLink="NhinSubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201301UV" xmlns:tns="urn:ihe:iti:pixv3:2007" portType="tns:PIXConsumer_PortType" inputVariable="PIX201301OutgoingIn" outputVariable="PIX201301OutgoingOut"/>
                        <assign name="Assign201301Resp">
                            <copy>
                                <from variable="PIX201301OutgoingOut" part="Body"/>
                                <to variable="PIX201301Out" part="PIXConsumer_PRPA_IN201301UVProxyResponse"/>
                            </copy>
                        </assign>
                        <assign name="AssignAudit201301Ack">
                            <copy>
                                <from variable="PIX201301Out" part="PIXConsumer_PRPA_IN201301UVProxyResponse"/>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:MCCI_IN000002UV01</to>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:assertion</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion</to>
                            </copy>
                            <copy>
                                <from>'Inbound'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201301In.PIXConsumer_PRPA_IN201301UVProxyRequest/hl7:PRPA_IN201301UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion/nccommon:uniquePatientId</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201301Ack" partnerLink="AuditRepositoryPL" operation="LogNhinSubjectDiscoveryAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogNhinSubjectDiscoveryAckIn" outputVariable="LogNhinSubjectDiscoveryAckOut"/>
                        <reply name="Reply201301" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201301UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201301Out"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201302UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201302In">
                <scope name="Handle201302Scope">
                    <variables>
                        <variable name="GetConnectionInfoEndpontFromNhinTargetIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetRequestMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogNhinSubjectDiscoveryAckRequestMessage"/>
                        <variable name="LogSubjectRevisedOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogSubjectRevisedIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogSubjectRevisedRequestMessage"/>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="PIX201302OutgoingOut" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:MCCI_IN000002UV01_Message"/>
                        <variable name="PIX201302OutgoingIn" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201302UV_Message"/>
                        <variable name="GetConnectionInfoEndpointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetResponseMessage"/>
                        <variable name="PIX201302Out" messageType="tns:PIXConsumer_PRPA_IN201302UVProxyResponseMessage"/>
                    </variables>
                    <faultHandlers>
                        <catch faultName="sxeh:systemFault" faultVariable="systemFault201302Var" faultMessageType="sxeh:faultMessage">
                            <sequence name="SystemFault201302Seq">
                                <assign name="AssignFaultAckDte">
                                    <sxt:trace>
                                        <sxt:log level="info" location="onStart">
                                            <bpel:from>'NhinProxySubjectDiscovery.bpel - A system fault was encounterd processing a 201302 message. Fault detials follow...'</bpel:from>
                                        </sxt:log>
                                        <sxt:log level="warning" location="onStart">
                                            <bpel:from variable="systemFault201302Var"/>
                                        </sxt:log>
                                    </sxt:trace>
                                    <copy>
                                        <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV/hl7:id</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV/hl7:receiver/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                    </copy>
                                    <copy>
                                        <from>'Error - Internal Gateway Error: Message Not Sent'</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeFaultAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                <assign name="Assign201302FaultInfo">
                                    <copy>
                                        <from variable="CreateAckOut" part="CreateAckResponse"/>
                                        <to variable="PIX201302Out" part="PIXConsumer_PRPA_IN201302UVProxyResponse"/>
                                    </copy>
                                </assign>
                                <reply name="ReplyNhinSubDisc201302Fault" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201302UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201302Out"/>
                                <exit name="ExitAfter201302FaultReturn"/>
                            </sequence>
                        </catch>
                    </faultHandlers>
                    <sequence name="Send201302Seq">
                        <assign name="AssignAudit201302">
                            <copy>
                                <from>'Outbound'</from>
                                <to>$LogSubjectRevisedIn.LogSubjectRevisedRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogSubjectRevisedIn.LogSubjectRevisedRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV</from>
                                <to>$LogSubjectRevisedIn.LogSubjectRevisedRequest/audit:message/hl7:PRPA_IN201302UV</to>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion</from>
                                <to>$LogSubjectRevisedIn.LogSubjectRevisedRequest/audit:message/hl7:assertion</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201302" partnerLink="AuditRepositoryPL" operation="LogSubjectRevised" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogSubjectRevisedIn" outputVariable="LogSubjectRevisedOut"/>
                        <assign name="AssignGetNhinConnectionInfo">
                            <copy>
                                <from>'subjectdiscovery'</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:serviceName</to>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:nhinTargetSystem</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:NhinTargetSystem</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeGetNhinConnectionInfo" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpontFromNhinTarget" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpontFromNhinTargetIn" outputVariable="GetConnectionInfoEndpointOut"/>
                        <assign name="AssignAssertion">
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:claimFormRaw</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:content"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:claimFormRef</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:contentReference"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:expirationDate</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:expirationDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystem</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:purposeForUseCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:purposeForUseCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:displayName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:purposeForUseDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:code</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:purposeForUseRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:dateOfSignature</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:signDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:givenName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userFirstName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:familyName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userLastName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:secondNameOrInitials</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userMiddleName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:userName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:org/nccommon:name</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userOrganization"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:code</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:displayName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userRoleCodeDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystem</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userRoleCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:userRoleCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>'subjectDiscovery'</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:action"/>
                            </copy>
                            <copy>
                                <from>string($GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference/soapaddr04:Address)</from>
                                <to variable="PIX201302OutgoingIn" property="pixv3:resource"/>
                            </copy>
                        </assign>
                        <assign name="AssignSendToGateway">
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV</from>
                                <to variable="PIX201302OutgoingIn" part="Body"/>
                            </copy>
                            <copy>
                                <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference)</from>
                                <to partnerLink="NhinSubjectDiscoveryPL"/>
                            </copy>
                        </assign>
                        <invoke name="InvokeSendToGateway" partnerLink="NhinSubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201302UV" xmlns:tns="urn:ihe:iti:pixv3:2007" portType="tns:PIXConsumer_PortType" inputVariable="PIX201302OutgoingIn" outputVariable="PIX201302OutgoingOut"/>
                        <assign name="Assign201302Resp">
                            <copy>
                                <from variable="PIX201302OutgoingOut" part="Body"/>
                                <to variable="PIX201302Out" part="PIXConsumer_PRPA_IN201302UVProxyResponse"/>
                            </copy>
                        </assign>
                        <assign name="AssignAudit201302Ack">
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:assertion</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion</to>
                            </copy>
                            <copy>
                                <from variable="PIX201302Out" part="PIXConsumer_PRPA_IN201302UVProxyResponse"/>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:MCCI_IN000002UV01</to>
                            </copy>
                            <copy>
                                <from>'Inbound'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201302In.PIXConsumer_PRPA_IN201302UVProxyRequest/hl7:PRPA_IN201302UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion/nccommon:uniquePatientId</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201302Ack" partnerLink="AuditRepositoryPL" operation="LogNhinSubjectDiscoveryAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogNhinSubjectDiscoveryAckIn" outputVariable="LogNhinSubjectDiscoveryAckOut"/>
                        <reply name="Reply201302" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201302UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201302Out"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201303UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201303In">
                <scope name="Handle201303Scope">
                    <variables>
                        <variable name="GetConnectionInfoEndpontFromNhinTargetIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetRequestMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogNhinSubjectDiscoveryAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogNhinSubjectDiscoveryAckRequestMessage"/>
                        <variable name="LogSubjectRevokedOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogSubjectRevokedIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogSubjectRevokedRequestMessage"/>
                        <variable name="PIX201303OutgoingOut" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:MCCI_IN000002UV01_Message"/>
                        <variable name="PIX201303OutgoingIn" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201303UV_Message"/>
                        <variable name="GetConnectionInfoEndpointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetResponseMessage"/>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="PIX201303Out" messageType="tns:PIXConsumer_PRPA_IN201303UVProxyResponseMessage"/>
                    </variables>
                    <faultHandlers>
                        <catch faultName="sxeh:systemFault" faultVariable="systemFault201303Var" faultMessageType="sxeh:faultMessage">
                            <sequence name="SystemFault201303Seq">
                                <assign name="AssignFaultAckDte">
                                    <sxt:trace>
                                        <sxt:log level="info" location="onStart">
                                            <bpel:from>'NhinProxySubjectDiscovery.bpel - A system fault was encounterd processing a 201303 message. Fault detials follow...'</bpel:from>
                                        </sxt:log>
                                        <sxt:log level="warning" location="onStart">
                                            <bpel:from variable="systemFault201303Var"/>
                                        </sxt:log>
                                    </sxt:trace>
                                    <copy>
                                        <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV/hl7:id</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                    </copy>
                                    <copy>
                                        <from>'Error - Internal Gateway Error: Message Not Sent'</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeFaultAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                <assign name="Assign201303FaultInfo">
                                    <copy>
                                        <from variable="CreateAckOut" part="CreateAckResponse"/>
                                        <to variable="PIX201303Out" part="PIXConsumer_PRPA_IN201303UVProxyResponse"/>
                                    </copy>
                                </assign>
                                <reply name="ReplyNhinSubDisc201303Fault" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201303UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201303Out"/>
                                <exit name="ExitAfter201303FaultReturn"/>
                            </sequence>
                        </catch>
                    </faultHandlers>
                    <sequence name="Send201303Seq">
                        <assign name="AssignAudit201303">
                            <copy>
                                <from>'Outbound'</from>
                                <to>$LogSubjectRevokedIn.LogSubjectRevokedRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogSubjectRevokedIn.LogSubjectRevokedRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV</from>
                                <to>$LogSubjectRevokedIn.LogSubjectRevokedRequest/audit:message/hl7:PRPA_IN201303UV</to>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion</from>
                                <to>$LogSubjectRevokedIn.LogSubjectRevokedRequest/audit:message/hl7:assertion</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201303" partnerLink="AuditRepositoryPL" operation="LogSubjectRevoked" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogSubjectRevokedIn" outputVariable="LogSubjectRevokedOut"/>
                        <assign name="AssignGetNhinConnectionInfo">
                            <copy>
                                <from>'subjectdiscovery'</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:serviceName</to>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:nhinTargetSystem</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:NhinTargetSystem</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeGetNhinConnectionInfo" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpontFromNhinTarget" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpontFromNhinTargetIn" outputVariable="GetConnectionInfoEndpointOut"/>
                        <assign name="AssignAssertion">
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:claimFormRaw</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:content"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:claimFormRef</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:contentReference"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:expirationDate</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:expirationDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystem</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:purposeForUseCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:purposeForUseCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:displayName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:purposeForUseDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:code</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:purposeForUseRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:dateOfSignature</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:signDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:givenName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userFirstName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:familyName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userLastName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:secondNameOrInitials</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userMiddleName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:userName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:org/nccommon:name</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userOrganization"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:code</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:displayName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userRoleCodeDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystem</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userRoleCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:userRoleCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>'subjectDiscovery'</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:action"/>
                            </copy>
                            <copy>
                                <from>string($GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference/soapaddr04:Address)</from>
                                <to variable="PIX201303OutgoingIn" property="pixv3:resource"/>
                            </copy>
                        </assign>
                        <assign name="AssignSendToGateway">
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV</from>
                                <to variable="PIX201303OutgoingIn" part="Body"/>
                            </copy>
                            <copy>
                                <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference)</from>
                                <to partnerLink="NhinSubjectDiscoveryPL"/>
                            </copy>
                        </assign>
                        <invoke name="InvokeSendToGateway" partnerLink="NhinSubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201303UV" xmlns:tns="urn:ihe:iti:pixv3:2007" portType="tns:PIXConsumer_PortType" inputVariable="PIX201303OutgoingIn" outputVariable="PIX201303OutgoingOut"/>
                        <assign name="Assign201303Resp">
                            <copy>
                                <from variable="PIX201303OutgoingOut" part="Body"/>
                                <to variable="PIX201303Out" part="PIXConsumer_PRPA_IN201303UVProxyResponse"/>
                            </copy>
                        </assign>
                        <assign name="AssignAudit201303Ack">
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:assertion</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion</to>
                            </copy>
                            <copy>
                                <from variable="PIX201303Out" part="PIXConsumer_PRPA_IN201303UVProxyResponse"/>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:MCCI_IN000002UV01</to>
                            </copy>
                            <copy>
                                <from>'Inbound'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201303In.PIXConsumer_PRPA_IN201303UVProxyRequest/hl7:PRPA_IN201303UV/hl7:controlActProcess/hl7:subject/hl7:registrationEvent/hl7:subject1/hl7:patient/hl7:id/@extension</from>
                                <to>$LogNhinSubjectDiscoveryAckIn.LogNhinSubjectDiscoveryAckRequest/audit:message/hl7:PIXConsumer_MCCI_IN000002UV01Request/hl7:assertion/nccommon:uniquePatientId</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeAudit201303Ack" partnerLink="AuditRepositoryPL" operation="LogNhinSubjectDiscoveryAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogNhinSubjectDiscoveryAckIn" outputVariable="LogNhinSubjectDiscoveryAckOut"/>
                        <reply name="Reply201303" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201303UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201303Out"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201304UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201304In">
                <scope name="Handle201304Scope">
                    <variables>
                        <variable name="GetConnectionInfoEndpontFromNhinTargetIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetRequestMessage"/>
                        <variable name="PIX201304OutgoingOut" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:MCCI_IN000002UV01_Message"/>
                        <variable name="PIX201304OutgoingIn" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201304UV_Message"/>
                        <variable name="GetConnectionInfoEndpointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetResponseMessage"/>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="PIX201304Out" messageType="tns:PIXConsumer_PRPA_IN201304UVProxyResponseMessage"/>
                    </variables>
                    <faultHandlers>
                        <catch faultName="sxeh:systemFault" faultVariable="systemFault201304Var" faultMessageType="sxeh:faultMessage">
                            <sequence name="SystemFault201304Seq">
                                <assign name="AssignFaultAckDte">
                                    <sxt:trace>
                                        <sxt:log level="info" location="onStart">
                                            <bpel:from>'NhinProxySubjectDiscovery.bpel - A system fault was encounterd processing a 201304 message. Fault detials follow...'</bpel:from>
                                        </sxt:log>
                                        <sxt:log level="warning" location="onStart">
                                            <bpel:from variable="systemFault201304Var"/>
                                        </sxt:log>
                                    </sxt:trace>
                                    <copy>
                                        <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:PRPA_IN201304UV/hl7:id</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:origMsgId</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:PRPA_IN201304UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>string($PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:PRPA_IN201304UV/hl7:sender/hl7:device/hl7:id/@root)</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:receiverOID</to>
                                    </copy>
                                    <copy>
                                        <from>'Error - Internal Gateway Error: Message Not Sent'</from>
                                        <to>$CreateAckIn.CreateAckRequest/hl7:msgText</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeFaultAckDte" partnerLink="SubDiscDataTransformsPL" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                                <assign name="Assign201304FaultInfo">
                                    <copy>
                                        <from variable="CreateAckOut" part="CreateAckResponse"/>
                                        <to variable="PIX201304Out" part="PIXConsumer_PRPA_IN201304UVProxyResponse"/>
                                    </copy>
                                </assign>
                                <reply name="ReplyNhinSubDisc201304Fault" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201304UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201304Out"/>
                                <exit name="ExitAfter201304FaultReturn"/>
                            </sequence>
                        </catch>
                    </faultHandlers>
                    <sequence name="Send201304Seq">
                        <assign name="AssignGetNhinConnectionInfo">
                            <copy>
                                <from>'subjectdiscovery'</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:serviceName</to>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:nhinTargetSystem</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:NhinTargetSystem</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeGetNhinConnectionInfo" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpontFromNhinTarget" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpontFromNhinTargetIn" outputVariable="GetConnectionInfoEndpointOut"/>
                        <assign name="AssignAssertion">
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:claimFormRaw</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:content"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:claimFormRef</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:contentReference"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:expirationDate</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:expirationDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystem</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:purposeForUseCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:purposeForUseCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:displayName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:purposeForUseDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:code</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:purposeForUseRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:dateOfSignature</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:signDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:givenName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userFirstName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:familyName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userLastName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:secondNameOrInitials</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userMiddleName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:userName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:org/nccommon:name</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userOrganization"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:code</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:displayName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userRoleCodeDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystem</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userRoleCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:userRoleCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>'subjectDiscovery'</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:action"/>
                            </copy>
                            <copy>
                                <from>string($GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference/soapaddr04:Address)</from>
                                <to variable="PIX201304OutgoingIn" property="pixv3:resource"/>
                            </copy>
                        </assign>
                        <assign name="AssignSendToGateway">
                            <copy>
                                <from>$PIX201304In.PIXConsumer_PRPA_IN201304UVProxyRequest/hl7:PRPA_IN201304UV</from>
                                <to variable="PIX201304OutgoingIn" part="Body"/>
                            </copy>
                            <copy>
                                <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference)</from>
                                <to partnerLink="NhinSubjectDiscoveryPL"/>
                            </copy>
                        </assign>
                        <invoke name="InvokeSendToGateway" partnerLink="NhinSubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201304UV" xmlns:tns="urn:ihe:iti:pixv3:2007" portType="tns:PIXConsumer_PortType" inputVariable="PIX201304OutgoingIn" outputVariable="PIX201304OutgoingOut"/>
                        <assign name="Assign201304Resp">
                            <copy>
                                <from variable="PIX201304OutgoingOut" part="Body"/>
                                <to variable="PIX201304Out" part="PIXConsumer_PRPA_IN201304UVProxyResponse"/>
                            </copy>
                        </assign>
                        <reply name="Reply201304" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201304UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201304Out"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201309UV" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201309In">
                <scope name="Handle201309Scope">
                    <variables>
                        <variable name="CreateFault201310Out" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateFault201310ResponseMessage"/>
                        <variable name="CreateFault201310In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateFault201310RequestMessage"/>
                        <variable name="GetConnectionInfoEndpontFromNhinTargetIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetRequestMessage"/>
                        <variable name="LogSubjectReidentOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogEventResponseMessage"/>
                        <variable name="LogSubjectReidentIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" messageType="tns:LogSubjectReidentRequestMessage"/>
                        <variable name="PIX201309OutgoingOut" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201310UV_Message"/>
                        <variable name="PIX201309OutgoingIn" xmlns:tns="urn:ihe:iti:pixv3:2007" messageType="tns:PRPA_IN201309UV_Message"/>
                        <variable name="GetConnectionInfoEndpointOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpontFromNhinTargetResponseMessage"/>
                        <variable name="PIX201309Out" messageType="tns:PIXConsumer_PRPA_IN201309UVProxyResponseMessage"/>
                    </variables>
                    <faultHandlers>
                        <catchAll>
                            <sequence name="SD201309FaultSeq">
                                <assign name="Assign201309FaultInfo">
                                    <copy>
                                        <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:PRPA_IN201309UV/hl7:receiver/hl7:device/hl7:id</from>
                                        <to>$CreateFault201310In.CreateFault201310Request/hl7:senderOID</to>
                                    </copy>
                                    <copy>
                                        <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:PRPA_IN201309UV/hl7:sender/hl7:device/hl7:id</from>
                                        <to>$CreateFault201310In.CreateFault201310Request/hl7:receiverOID</to>
                                    </copy>
                                </assign>
                                <invoke name="InvokeCreateFault201310" partnerLink="SubDiscDataTransformsPL" operation="CreateFault201310" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateFault201310In" outputVariable="CreateFault201310Out"/>
                                <assign name="Assign1">
                                    <copy>
                                        <from variable="CreateFault201310Out" part="CreateFault201310Response"/>
                                        <to variable="PIX201309Out" part="PIXConsumer_PRPA_IN201309UVProxyResponse"/>
                                    </copy>
                                </assign>
                                <reply name="ReplyNhinSubDisc201309Fault" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201309UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201309Out"/>
                                <exit name="ExitAfter201309FaultReturn"/>
                            </sequence>
                        </catchAll>
                    </faultHandlers>
                    <sequence name="Send201309Seq">
                        <!-- TODO: Add AuditLog when DTE is implemented -->
                        <assign name="AssignGetNhinConnectionInfo">
                            <copy>
                                <from>'subjectdiscovery'</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:serviceName</to>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:nhinTargetSystem</from>
                                <to>$GetConnectionInfoEndpontFromNhinTargetIn.GetConnectionInfoEndpontFromNhinTargetRequest/conninfo:NhinTargetSystem</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeGetNhinConnectionInfo" partnerLink="ConnectionMgrPL" operation="GetConnectionInfoEndpontFromNhinTarget" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpontFromNhinTargetIn" outputVariable="GetConnectionInfoEndpointOut"/>
                        <assign name="AssignAssertion">
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:claimFormRaw</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:content"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:claimFormRef</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:contentReference"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:expirationDate</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:expirationDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystem</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:purposeForUseCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:purposeForUseCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:displayName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:purposeForUseDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:purposeOfDisclosureCoded/nccommon:code</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:purposeForUseRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:dateOfSignature</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:signDate"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:givenName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userFirstName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:familyName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userLastName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:personName/nccommon:secondNameOrInitials</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userMiddleName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:userName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:org/nccommon:name</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userOrganization"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:code</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userRoleCode"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:displayName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userRoleCodeDisplayName"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystem</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userRoleCodeSystem"/>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion/nccommon:userInfo/nccommon:roleCoded/nccommon:codeSystemName</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:userRoleCodeSystemName"/>
                            </copy>
                            <copy>
                                <from>'subjectDiscovery'</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:action"/>
                            </copy>
                            <copy>
                                <from>string($GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference/soapaddr04:Address)</from>
                                <to variable="PIX201309OutgoingIn" property="pixv3:resource"/>
                            </copy>
                        </assign>
                        <assign name="AssignLog201309">
                            <copy>
                                <from>'Outbound'</from>
                                <to>$LogSubjectReidentIn.LogSubjectReidentRequest/audit:direction</to>
                            </copy>
                            <copy>
                                <from>'Nhin'</from>
                                <to>$LogSubjectReidentIn.LogSubjectReidentRequest/audit:interface</to>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:PRPA_IN201309UV</from>
                                <to>$LogSubjectReidentIn.LogSubjectReidentRequest/audit:message/hl7:PRPA_IN201309UV</to>
                            </copy>
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:assertion</from>
                                <to>$LogSubjectReidentIn.LogSubjectReidentRequest/audit:message/hl7:assertion</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeLog201309Send" partnerLink="AuditRepositoryPL" operation="LogSubjectReident" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentinternalauditrepository" portType="tns:NhincComponentInternalAuditRepositoryPortType" inputVariable="LogSubjectReidentIn" outputVariable="LogSubjectReidentOut"/>
                        <assign name="AssignSendToGateway">
                            <copy>
                                <from>$PIX201309In.PIXConsumer_PRPA_IN201309UVProxyRequest/hl7:PRPA_IN201309UV</from>
                                <to variable="PIX201309OutgoingIn" part="Body"/>
                            </copy>
                            <copy>
                                <from>bpel:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointOut.GetConnectionInfoEndpontFromNhinTargetResponse/nccommon:EndpointReference)</from>
                                <to partnerLink="NhinSubjectDiscoveryPL"/>
                            </copy>
                        </assign>
                        <invoke name="InvokeSendToGateway" partnerLink="NhinSubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201309UV" xmlns:tns="urn:ihe:iti:pixv3:2007" portType="tns:PIXConsumer_PortType" inputVariable="PIX201309OutgoingIn" outputVariable="PIX201309OutgoingOut"/>
                        <assign name="Assign201309Resp">
                            <copy>
                                <from variable="PIX201309OutgoingOut" part="Body"/>
                                <to variable="PIX201309Out" part="PIXConsumer_PRPA_IN201309UVProxyResponse"/>
                            </copy>
                        </assign>
                        <reply name="Reply201309" partnerLink="NhincProxySubjectDiscoveryPL" operation="PIXConsumer_PRPA_IN201309UV" portType="tns:NhincProxySubjectDiscoveryPortType" variable="PIX201309Out"/>
                    </sequence>
                </scope>
            </onMessage>
        </pick>
    </sequence>
</process>
