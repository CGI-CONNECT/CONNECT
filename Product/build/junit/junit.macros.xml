<?xml version="1.0" encoding="UTF-8"?>
<project name="junit.macros" >

  <macrodef name="run.if.unit.tests.are.out.of.date">
    <element name="do"/>
    <sequential>
      <echo message="check if tests are out of date" />
      <mkdir dir="${unittest.report.dir}"/>

      <path id="sourcefiles" >
        <fileset dir="${build.dist.root}">
          <include name="**/*" />
        </fileset>
        <fileset dir="${build.dir}/test">
          <include name="**/*" />
        </fileset>
      </path>

      <var unset="true" name="sourcefiles"/>
      <pathconvert targetos="${os.family}" property="sourcefiles" refid="sourcefiles" />

      <path id="targetfiles" >
        <fileset dir="${unittest.report.dir}">
          <include name="**/*" />
        </fileset>
      </path>

      <var unset="true" name="targetfiles"/>
      <pathconvert targetos="${os.family}" property="targetfiles" refid="targetfiles" />

      <var unset="true" name="has.some"/>
      <pathconvert property="has.some" setonempty="false">
        <path>
          <fileset dir="${unittest.report.dir}" includes="*"/>
        </path>
      </pathconvert>

      <if>
        <isset property="has.some"/>
        <then>
          <var name="unittests.force" value="false"/>
        </then>
        <else>
          <var name="unittests.force" value="true"/>
        </else>
      </if>

      <outofdate verbose="${debug}" force="${unittests.force}" >
        <sourcefiles>
          <pathelement path="${sourcefiles}"/>
        </sourcefiles>
        <targetfiles>
          <pathelement path="${targetfiles}"/>
        </targetfiles>
        <sequential>
          <do/>
        </sequential>
      </outofdate>
    </sequential>
  </macrodef>

  <macrodef name="junitrun">
    <attribute name="reportfile" />
    <attribute name="testtype" />
    <attribute name="verbose" default="false" />
    <attribute name="genreport" default="${called.from.main.build}" />
    <attribute name="classpathrefid" default="junitrun.classpath"/>
    <element name="tests"/>
    <sequential>
      <var unset="true" name="reportdir" />
      <var unset="true" name="reportfilename" />
      <var unset="true" name="junit.basedir" />
      <basename property="reportfilename" file="@{reportfile}" />
      <dirname property="reportdir" file="@{reportfile}" />
      <dirname property="junit.basedir" file="${reportdir}" />

      <delete dir="${reportdir}" />
      <mkdir dir="${reportdir}" />

      <property name="coverage.file" location="${coverage.classes.report.file}"/>
      <property name="cp.part" refid="@{classpathrefid}"/>
      <var name="cp" value=""/>
            
            <var name="cp" value="${cp.part}"/>
      
      <junitrunner dir="${junit.basedir}" failureproperty="unittest.failure" printSummary="yes" fork="true" forkmode="once" showoutput="true">
        <sysproperty key="basedir" value="${junit.basedir}" />
        <sysproperty key="net.sourceforge.cobertura.datafile" file="${coverage.file}" />
        <env key="CLASSPATH" value="${cp}"/>
        
        <formatter type="xml" />
        <formatter usefile="false" type="plain" />

        <batchtest todir="${reportdir}">
          <tests/>
        </batchtest>
      </junitrunner>

      <if>
        <isfalse value="@{genreport}" />
        <then>
          <junitreportplus reportfile="@{reportfile}" testtype="@{testtype}">
            <xmlreports>
              <fileset dir="${junit.basedir}">
                <include name="@{testtype}-test-reports/TEST-*.xml" />
              </fileset>
            </xmlreports>
          </junitreportplus>
        </then>
      </if>
    </sequential>
  </macrodef>

  <macrodef name="junitreportplus">
    <attribute name="reportfile" />
    <attribute name="testtype" />
    <element name="xmlreports" />
    <sequential>
      <var unset="true" name="reportdir" />
      <var unset="true" name="reportfilename" />
      <basename property="reportfilename" file="@{reportfile}" />
      <dirname property="reportdir" file="@{reportfile}" />

      <mkdir dir="${reportdir}" />
      <delete dir="@{reportfile}" />

      <junitreport todir="${reportdir}" tofile="${reportfilename}">
        <xmlreports />
        <report format="frames" todir="${reportdir}" />
      </junitreport>

      <available file="@{reportfile}" property="test.report.exists" value="true" />
      <if>
        <isset property="test.report.exists" />
        <then>
          <xmltask source="@{reportfile}">
            <call path="/">
              <param name="has.errors" path="boolean(/testsuites//testsuite[@errors>0] or /testsuites//testsuite[@failures>0])" />
              <actions>
                <if>
                  <istrue value="@{has.errors}" />
                  <then>
                    <fail message="Atleast one @{testtype} test has failed!" />
                  </then>
                </if>
              </actions>
            </call>
          </xmltask>
        </then>
        <else>
          <fail message="It doesn't look like any @{testtype} were run, so the build was failed!" />
        </else>
      </if>
    </sequential>
  </macrodef>


</project>