<?xml version="1.0" encoding="UTF-8"?>
<project name="soapui.targets">

  <import file="soapui.properties.xml" />
  <import file="soapui.macros.xml" />

  <target name="soapui.help">
    <echo taskname="help">
      soapui.run - executes all soapui project files found in the project if it has the property soapui.hasTests set to true.  A soapui
      project file has the format of *-soapui-project.xml.
    </echo>
  </target>

  <target name="soapui.clean">
    <delete dir="${soapui.report.dir}" failonerror="true" />
  </target>

  <target name="-soapui.run">
    <if>
      <istrue value="${soapui.hasTests}" />
      <then>
		<call target="-soapui.find.and.run.tests"/>
      	<call target="-soapui.generate.report"/>
      </then>
      <else>
        <echo message="The project ${project.name} is not marked as having soapui tests: property soapui.hasTests=${soapui.hasTests}." />
      </else>
    </if>
  </target>

  <target name="-soapui.find.and.run.tests">
    <delete dir="${soapui.report.dir}" />
  	<mkdir dir="${soapui.report.dir}"/>
    <for param="soapui.project.file.path">
      <path>
        <fileset dir="${project.dir}">
          <include name="**/${soapui.project.file.pattern}"/>
        </fileset>
      </path>
      <sequential>

        <var unset="true" name="soapui.project.name" />
      	<basename file="@{soapui.project.file.path}" suffix=".xml" property="soapui.project.name"/>
      	<script language="javascript">
			<![CDATA[
				projectName = project.getProperty("soapui.project.name");
      			
      			projectName = projectName.replace("-soapui-project", "");
      			
				project.setProperty("soapui.project.name", projectName);
				]]>
		</script>

        <exec dir="${soapui.install.bin.directory.path}" osfamily="windows" executable="cmd.exe">
          <arg line='/c testrunner.bat -j -a -f"${soapui.report.dir}/${soapui.project.name}" "@{soapui.project.file.path}" -Dproject.name="${project.name}"'/>
        </exec>
      	
        <exec dir="${soapui.install.bin.directory.path}"  osfamily="unix" executable="bash">        	
            <arg line='testrunner.sh -j -a -f"${soapui.report.dir}/${soapui.project.name}" "@{soapui.project.file.path}" -Dproject.name="${project.name}"'/>
        	
        </exec>
        

       <move file="${soapui.report.dir}/${soapui.project.name}/report.xml" tofile="${soapui.report.dir}/${soapui.project.name}/TEST-${soapui.project.name}_TestSuite.xml"/>

		<replace
			file="${soapui.report.dir}/${soapui.project.name}/TEST-${soapui.project.name}_TestSuite.xml"
			value="">
			<replacefilter token="&lt;testsuites&gt;"/>
			<replacefilter token="&lt;/testsuites&gt;"/>
	    </replace>
      	<delete file="${soapui.report.dir}/${soapui.project.name}/TEST-${soapui.project.name}TestSuite.xml"/>   
		<delete file="${soapui.report.dir}/${soapui.project.name}/TEST-${soapui.project.name}.xml"/>   
      </sequential>
    </for>
  </target>
	
	<target name="-soapui.generate.report">
		<if>
			<isfalse value="${called.from.main.build}" />
			<then>
				<junitreportplus reportfile="${soapui.report.dir}/SoapUITests.xml" testtype="soapui">
					<xmlreports>
						<fileset dir="${soapui.report.dir}">
							<include name="**/TEST-*.xml" />
						</fileset>
					</xmlreports>
				</junitreportplus>
			</then>
		</if>
	</target>

</project>