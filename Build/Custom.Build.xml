<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Custom">
  
	<target name="Build.PublishZip">
    <zip zipfile="${Common.TempDirectory}\AdapterSDK.zip" includeemptydirs="true">
      <fileset basedir="${ProductionDirectory}\" >
        <include name="Interfaces\src\schemas\Agency\**" />
      </fileset>
      <fileset basedir="${ProductionDirectory}\" >
        <include name="Interfaces\src\wsdl\AdapterService.wsdl" />
      </fileset>
      <fileset basedir="${ProductionDirectory}\" >
        <include name="Interfaces\src\wsdl\EntityService.wsdl" />
      </fileset>
    </zip>
    
    <saveproperties file="${Common.TempDirectory}\ReleaseInfo.txt" format="CommandLine" >
      <property name="CCNetLabel"/>
      <property name="CnCNetBuildDate"/>
      <property name="CCNetBuildTime"/>
    </saveproperties>

    <property name="InstallerZip.FileName" value="${ProjectName}-Release-Installer-${CCNetLabel}.zip"/>
    <property name='InstallerZip.FilePath' value='${Common.ArtifactDirectoryPath}\${InstallerZip.FileName}'/>

    <zip zipfile="${InstallerZip.FilePath}">
      <fileset basedir="${Common.TempDirectory}">
        <include name="ReleaseInfo.txt"/>
        <include name="AdapterSDK.zip"/>
      </fileset>
      <fileset prefix="nhinc" basedir="${ProductionDirectory}\CommonBin">
        <include name="*.jar" />
      </fileset>
      <fileset prefix="SoapUI" basedir="${ProductDirectory}\UnitTest\SoapUI">
        <include name="**\*" />
      </fileset>
      <fileset prefix="nhinc">
        <include name="${ProductionDirectory}\Adapters\**\dist\*"/>
        <include name="${ProductionDirectory}\Common\**\dist\*"/>
        <include name="${ProductionDirectory}\Gateway\**\dist\*"/>
      </fileset>
      <fileset basedir="${InstallDirectory}\AppDeploy">
        <include name="**\*"/>
      </fileset>
    </zip>

    <property name="Deployment.FileWebName" value="${InstallerZip.FileName}"/>
    <property name="Deployment.FileWebPath"	value="${Deployment.WebPathRoot}/${Common.ArtifactFolderName}/${Deployment.FileWebName}" />
   
    <call target="Deployment.PublishLink" />
	</target>

  <target name="Common.FindBuild">
    <strings id="builds"/>

    <function execute="${ccnet::get-project-some-build-labels(CCNetRemotingUrl, ProjectNameToPullFrom, 15, 'builds') }"/>

    <loopthrough property="build">
      <items>
        <strings refid="builds"/>
      </items>
      <do>
        <trycatch>
          <try>
            <regex input="${build}" pattern="log\d+Lbuild\.${CCNetLabel}\.xml$"/>
            <break/>
          </try>
          <catch/>
        </trycatch>
      </do>
    </loopthrough>
  </target>
  
</project>
