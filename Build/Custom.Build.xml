<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Custom">
  
	<target name="Build.PublishZips">
    <call target="Build.PublishZip.Release.Installer"/>
    <call target="Build.PublishZip.Release.Domains.Configuration"/>
    <call target="Build.PublishZip.Release.DBScripts"/>
    <call target="Build.PublishZip.Release.Interfaces"/>
  </target>

  <target name="Build.PublishZip.Release.Installer">
    <saveproperties file="${Common.Project.TempDirectory}\ReleaseInfo.txt" format="CommandLine" >
      <property name="CCNetLabel"/>
      <property name="CCNetBuildDate"/>
      <property name="CCNetBuildTime"/>
    </saveproperties>
    
    <property name="Installer.Zip.FileName" value="${ProjectFullName}_Binaries_${CCNetLabel}.zip"/>
    <property name="Installer.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Installer.Zip.FileName}"/>

    <zip zipfile="${Installer.Zip.FilePath}">
      <fileset basedir="${GlassFish.Deploy.Directory.Path}">
        <include name="**\*"/>
      </fileset>
      <fileset basedir="${Common.Project.TempDirectory}">
        <include name="ReleaseInfo.txt"/>
      </fileset>
      <fileset basedir="${Common.Directory.Install.Path}">
        <include name="**\*"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Installer.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
  </target>

  <target name="Build.PublishZip.Release.Interfaces">
    <property name="Interfaces.Zip.FileName" value="${ProjectFullName}_Interfaces_${CCNetLabel}.zip"/>
    <property name="Interfaces.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Interfaces.Zip.FileName}"/>

    <zip zipfile="${Interfaces.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\" >
        <include name="Common\Interfaces\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Interfaces.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
  </target>
  
  <target name="Build.PublishZip.Release.DBScripts">
    <property name="DBScripts.Zip.FileName" value="${ProjectFullName}_DBScripts_${CCNetLabel}.zip"/>
    <property name="DBScripts.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${DBScripts.Zip.FileName}"/>

    <zip zipfile="${DBScripts.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Product.Path}\" >
        <include name="DBScripts\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${DBScripts.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
  </target>
  
  <target name="Build.PublishZip.Release.Domains.Configuration">
    <property name="Domains.Configuration.Zip.FileName" value="${ProjectFullName}_Domains_Configuration_${CCNetLabel}.zip"/>
    <property name="Domains.Configuration.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Domains.Configuration.Zip.FileName}"/>

    <zip zipfile="${Domains.Configuration.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties">
        <include name="Dev/**"/>
        <include name="Red4/**"/>
        <include name="Blue4/**"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Domains.Configuration.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />
    
    <call target="Publish.Link" />
    <!-- Dev -->
    <property name="Domains.Configuration.Zip.FileName" value="${ProjectFullName}_Properties_${CCNetLabel}.zip"/>
    <property name="Domains.Configuration.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Domains.Configuration.Zip.FileName}"/>

    <zip zipfile="${Domains.Configuration.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\Dev">
        <include name="**/*"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Domains.Configuration.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
    <!-- Red4 -->
    <property name="Domains.Configuration.Zip.FileName" value="${ProjectFullName}_Properties_Red4_${CCNetLabel}.zip"/>
    <property name="Domains.Configuration.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Domains.Configuration.Zip.FileName}"/>

    <zip zipfile="${Domains.Configuration.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\Red4">
        <include name="**/*"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Domains.Configuration.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
    <!-- Blue4 -->
    <property name="Domains.Configuration.Zip.FileName" value="${ProjectFullName}_Properties_Blue4_${CCNetLabel}.zip"/>
    <property name="Domains.Configuration.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Domains.Configuration.Zip.FileName}"/>

    <zip zipfile="${Domains.Configuration.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\Blue4">
        <include name="**/*"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Domains.Configuration.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
    
  </target>

  <target name="Common.FindBuild">
    <strings id="builds"/>

    <function execute="${ccnet::get-project-some-build-labels(CCNetRemotingUrl, ProjectNameToPullFrom, 15, 'builds') }"/>

    <loopthrough property="build">
      <items>
        <strings refid="builds"/>
      </items>
      <do>
        <trycatch>
          <try>
            <regex input="${build}" pattern="log\d+Lbuild\.${CCNetLabel}\.xml$"/>
            <break/>
          </try>
          <catch/>
        </trycatch>
      </do>
    </loopthrough>
  </target>

  <macrodef name="ask.published.good.build">
    <attributes>
      <attribute name="resultproperty" default="Build.Version" type="string"/>
      <attribute name="remotingurl" default="${CCNet.Server.Remoting.Url}" type="string"/>
      <attribute name="project" default="${ProjectName}-${ProjectCodeLineName}-Release" type="string"/>
    </attributes>
    <sequential>

      <strings id="goodbuilds"/>
      <strings id="builds"/>

      <function execute="${ccnet::get-project-some-build-labels(remotingurl, project, 15, 'builds') }"/>

      <property name="count" value="0"/>

      <loopthrough property="build">
        <items>
          <strings refid="builds"/>
        </items>
        <do>
          <trycatch>
            <try>
              <regex input="${build}" pattern="log\d+Lbuild\.(?'Label'.*)\.xml$"/>
              <function execute="${stringlist::add('goodbuilds', Label)}"/>
              <property name="count" value="${int::parse(count) + 1}"/>
            </try>
            <catch/>
          </trycatch>
          <break if="${int::parse(count) == 6}"/>
        </do>
      </loopthrough>

      <ask
          answer="${resultproperty}"
          caption="Choose which build?"
          question="Choose which build?">
        <options refid="goodbuilds" />
      </ask>
    </sequential>
  </macrodef>

  <macrodef name="get.published.artifact">
    <attributes>
      <attribute name="artifact" require="True" type="string"/>
      <attribute name="dest" require="True" type="string"/>
      <attribute name="build" require="True" type="string"/>
      <attribute name="remotingurl" default="${CCNet.Server.Remoting.Url}" type="string"/>
      <attribute name="project" default="${ProjectName}-${ProjectCodeLineName}-Release" type="string"/>
      <attribute name="webroot" default="http://${BuildServerHostName}/${ProjectName}-${ProjectCodeLineName}/${Common.Directory.ArtifactRoot.Name}" type="string"/>
      <attribute name="username" default="${Web.Credentials.UserName}" type="string"/>
      <attribute name="password" default="${Web.Credentials.Password}" type="string"/>
    </attributes>
    <sequential>

      <strings id="builds"/>
      <function execute="${ccnet::get-project-some-build-labels(remotingurl, project, 15, 'builds') }"/>
      <loopthrough property="BuildName">
        <items>
          <strings refid="builds"/>
        </items>
        <do>
          <trycatch>
            <try>
              <regex input="${BuildName}" pattern="log(?'BuildArchiveFolderName'\d+)Lbuild\.${build}\.xml$"/>
              <break/>
            </try>
            <catch/>
          </trycatch>
        </do>
      </loopthrough>

      <regex input="${BuildArchiveFolderName}" pattern="(?'Year'\d\d\d\d)(?'Month'\d\d)(?'Day'\d\d)"/>

      <mkdir dir="${path::get-directory-name(dest)}" unless="${directory::exists(path::get-directory-name(dest))}"/>

      <get
        dest="${dest}"
        src="${webroot}/${BuildArchiveFolderName}/${artifact}"
        verbose="true"
      >
        <credentials username="${username}" password="${password}"/>
      </get>
    </sequential>
  </macrodef>

</project>
