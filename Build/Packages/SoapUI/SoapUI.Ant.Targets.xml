<?xml version="1.0" encoding="UTF-8"?>
<project name="nhinc-integrationtests" default="soapui.run" basedir=".">

  <taskdef resource="net/sf/antcontrib/antlib.xml"/>

  <property name="IntegrationTest.Dir" value="C:/Projects/NHINC/Current/Product/IntegrationTest"/>
  <property name="IntegrationTest.Results.Dir" value="${IntegrationTest.Dir}/results"/>
  <property name="SoapUI.Dir" value="C:/soapUI-Pro-current/bin"/>
  
  <target name="soapui.run" depends="run-tests,build-report" />

  <target name="init-tests">
    <delete dir="${IntegrationTest.Results.Dir}" failonerror="true"/>
    <mkdir dir="${IntegrationTest.Results.Dir}"/>
  </target>

  <target name="run-tests" depends="init-tests">
    <var name="counter" value="1"/>

    <for param="file">
      <path>
        <fileset dir="${IntegrationTest.Dir}">
          <include name="InternalSelfTest-soapui-project.xml"/>
          <include name="EndToEndSelfTest-soapui-project.xml"/>
          <include name="ValidateServices-soapui-project.xml"/>
          <include name="PatientCorrelation-soapui-project.xml"/>
          <include name="AuditQueryTestHelper-soapui-project.xml"/>
        </fileset>
      </path>
      <sequential>
        <echo message="@{file}"/>
        <echo message="${counter}"/>

        <exec dir="${SoapUI.Dir}" executable="cmd.exe">
          <arg line="/c testrunner.bat -j -a -f${IntegrationTest.Results.Dir}/test_${counter} @{file}"/>
        </exec>
        
        <!-- 
          JUnit Report task requires that the input.xml files be unique. 
          The SoapUI executable outputs each test's report summary as report.xml need to rename each report.xml file. 
				-->
        <move file="${IntegrationTest.Results.Dir}/test_${counter}/report.xml" tofile="${IntegrationTest.Results.Dir}\test_${counter}\report${counter}.xml"/>
        <math result="counter" operand1="${counter}" operation="+" operand2="1" datatype="int"/>
      </sequential>
    </for>
  </target>

  <target name="build-report" >
    <replace dir="${IntegrationTest.Results.Dir}" token="&lt;testsuites&gt;" value="">
      <include name="**/*.xml"/>
    </replace>
    
    <replace dir="${IntegrationTest.Results.Dir}" token="&lt;/testsuites&gt;" value="">
      <include name="**/*.xml"/>
    </replace>

    <junitreport 	todir="${IntegrationTest.Results.Dir}"   	tofile="IntegrationTests.xml">
      <fileset dir="${IntegrationTest.Results.Dir}">
        <include name="**/report*.xml"/>
      </fileset>
      <report format="frames" todir="${IntegrationTest.Results.Dir}/html" />
    </junitreport>
  </target>

</project>
