<?xml version="1.0" encoding="utf-8" ?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="GlassFish.Custom">

  <target name="GlassFish.Redeploy.Release.Build.SetUp">
    <property name="CCNetRemotingUrl" value="tcp://${BuildServerHostName}:${CCNet.Server.Remoting.Port}/CruiseManager.rem"/>
    <property name="ProjectNameToPullFrom" value="${ProjectName}-${ProjectCodeLineName}-Release"/>

    <call target="Common.FindBuild"/>
    <regex input="${build}" pattern="log(?'BuildArchiveFolderName'\d+)Lbuild\.${CCNetLabel}\.xml$"/>

    <property name="Release.Application.Zip.File.Name" value="${ProjectFullName}_Binaries_${CCNetLabel}.zip"/>
    <property name="Release.Application.Zip.File.Path" value="${Common.Project.TempDirectory}\${Release.Application.Zip.File.Name}"/>
        
    <get
      dest="${Release.Application.Zip.File.Path}"
      src="http://${BuildServerHostName}/${ProjectName}-${ProjectCodeLineName}/Artifacts/${BuildArchiveFolderName}/${Release.Application.Zip.File.Name}"
      verbose="true"
    >
      <credentials username="${Web.Credentials.UserName}" password="${Web.Credentials.Password}"/>
    </get>

    <property name="Release.Domains.Configuration.Zip.File.Name" value="${ProjectFullName}_Domains_Configuration_${CCNetLabel}.zip"/>
    <property name="Release.Domains.Configuration.Zip.File.Path" value="${Common.Project.TempDirectory}\${Release.Domains.Configuration.Zip.File.Name}"/>
    
    <get
      dest="${Release.Domains.Configuration.Zip.File.Path}"
      src="http://${BuildServerHostName}/${ProjectName}-${ProjectCodeLineName}/Artifacts/${BuildArchiveFolderName}/${Release.Domains.Configuration.Zip.File.Name}"
      verbose="true"
    >
      <credentials username="${Web.Credentials.UserName}" password="${Web.Credentials.Password}"/>
    </get>

    <delete dir="${GlassFish.Deploy.Directory.Path}" if="${directory::exists(GlassFish.Deploy.Directory.Path)}"/>
    
    <unzip todir="${GlassFish.Deploy.Directory.Path}" zipfile="${Release.Application.Zip.File.Path}"/>
    <unzip todir="${GlassFish.Deploy.Directory.Path}" zipfile="${Release.Domains.Configuration.Zip.File.Path}"/>
  </target>

  <target name="GlassFish.Redeploy.Release.Build.Integration">
    <call target="GlassFish.Redeploy.Release.Build.SetUp"/>
    <call target="GlassFish.Redeploy"/>
  </target>

  <target name="GlassFish.Redeploy.Release.Build.Staging">
    <call target="GlassFish.Redeploy.Release.Build.SetUp"/>
    <call target="GlassFish.Staging.Redeploy"/>
  </target>
  
</project>
