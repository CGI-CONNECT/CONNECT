<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="GlassFish">

  <stringadd refid="Personal.UpdateSource.Before.Target.List">
    <string value="GlassFish.StopServer"/>
  </stringadd>

  <stringadd refid="Personal.UpdateSource.After.Target.List">
    <string value="GlassFish.RestartServer"/>
  </stringadd>

  <target name="GlassFish.RestartServer">
    <call target="GlassFish.StartServer" if="${GlassFish.Status=='Started'}"/>
  </target>

  <target name="GlassFish.StartServer">
    <call target="GlassFish.GetServerStatus"/>
    <if test="${GlassFish.Status == 'Stopped'}">
      <asyncexec
        createnowindow="true"
        redirectoutput="false"
        useshellexecute="true"
        waitforexit="true"
        taskname="GlassFishStart"
        program="cmd"
        workingdir="${path::get-directory-name(GlassFish.ApplicationServer.File.Path)}"
        verbose="true"
      >
        <arg line='/C "${GlassFish.ApplicationServer.File.Path}" start-domain ${GlassFish.Domain.Name}' />
      </asyncexec>
      <waitforexit>
        <tasknames>
          <string value='GlassFishStart'/>
        </tasknames>
      </waitforexit>
  </if>
  </target>

  <target name="GlassFish.StopServer">
    <call target="GlassFish.GetServerStatus"/>
    <if test="${GlassFish.Status == 'Started'}">
      <exec
        program="cmd"
        workingdir="${path::get-directory-name(GlassFish.ApplicationServer.File.Path)}"
        verbose="true"
      >
        <arg line='/C "${GlassFish.ApplicationServer.File.Path}" stop-domain ${GlassFish.Domain.Name}' />
      </exec>
    </if>
  </target>

  <target name="GlassFish.GetServerStatus">
    <trycatch>
      <try>
        <get
         src="http://localhost:${GlassFish.Port}"
         dest="${environment::get-variable('TEMP')}\GlassFish-status.txt"
        />
        <loadfile file="${environment::get-variable('TEMP')}\GlassFish-status.txt" property="GlassFish.Status" />
        <ifthenelse test="${string::contains(GlassFish.Status, 'error')}">
          <then>
            <property name="GlassFish.Status" value="Stopped"/>
          </then>
          <else>
            <property name="GlassFish.Status" value="Started"/>
          </else>
        </ifthenelse>
      </try>
      <catch>
        <property name="GlassFish.Status" value="Stopped"/>
      </catch>
    </trycatch>
  </target>

  <target name="GlassFish.Redeploy">
    <call target="GlassFish.Undeploy"/>

    <call target="GlassFish.Deploy"/>
  </target>
  
  <target name="GlassFish.Undeploy">
    <call target="GlassFish.StartServer"/>

    <ant
      target="undeploy"
      buildfile="${GlassFish.Deploy.Script.File.Path}"
      logfile="${Ant.Log.Directory.Path}\undeploy_log.xml"
    >
      <environment refid="${Common.EnvironmentVariables.RefId}"/>
      <args/>
    </ant>
  </target>
  
  <target name="GlassFish.Deploy">
    <call target="GlassFish.StopServer"/>

    <ant
      target="deploy.shared"
      buildfile="${GlassFish.Deploy.Script.File.Path}"
      logfile="${Ant.Log.Directory.Path}\undeploy_log.xml"
    >
      <environment refid="${Common.EnvironmentVariables.RefId}"/>
      <args/>
    </ant>
    
    <call target="GlassFish.StartServer"/>
    
    <ant
      target="deploy"
      buildfile="${GlassFish.Deploy.Script.File.Path}"
      logfile="${Ant.Log.Directory.Path}\undeploy_log.xml"
    >
      <environment refid="${Common.EnvironmentVariables.RefId}"/>
      <args/>
    </ant>
  </target>

  <target name="GlassFish.SetUp">
  </target>

  <target name="GlassFish.TearDown">
  </target>
  
</project>
