<?xml version="1.0" encoding="UTF-8"?>
<process
    name="NhincComponentInternalSubDiscovery201309Orch"
    targetNamespace="http://enterprise.netbeans.org/bpel/NhincInternalOrchBPEL/NhincComponentInternalSubDiscovery201309Orch"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="http://enterprise.netbeans.org/bpel/NhincInternalOrchBPEL/NhincComponentInternalSubDiscovery201309Orch" 
    xmlns:hl7="urn:hl7-org:v3" 
    xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" 
    xmlns:ncevent="urn:gov:hhs:fha:nhinc:common:eventcommon" 
    xmlns:ncpolicydte="urn:gov:hhs:fha:nhinc:common:policyenginedte" 
    xmlns:oasis="urn:oasis:names:tc:xacml:2.0:context:schema:os" 
    xmlns:nccommadapt="urn:gov:hhs:fha:nhinc:common:nhinccommonadapter" 
    xmlns:ns0="urn:gov:hhs:fha:nhinc:common:connectionmanagerinfo" 
    xmlns:propacc="urn:gov:hhs:fha:nhinc:common:propertyaccess" 
    xmlns:ns2="urn:gov:hhs:fha:nhinc:common:nhinccommon" 
    xmlns:ns3="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
    <import namespace="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" location="Interfaces/wsdl/NhincComponentInternalSubDiscovery201309Orch.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhincproxysubjectdiscovery" location="Interfaces/wsdl/NhincProxySubjectDiscovery.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" location="Interfaces/wsdl/NhincComponentInternalPolicyEngineFacade.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:adapterreidentification" location="Interfaces/wsdl/AdapterReidentification.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" location="Interfaces/wsdl/NhincComponentSubDiscTransforms.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" location="Interfaces/wsdl/NhincComponentConnectionManager.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" location="Interfaces/wsdl/NhincComponentPropAccessor.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="NhincPropAccessorPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" partnerLinkType="tns:NhincComponentPropAccessor" partnerRole="NhincComponentPropAccessorPortTypeRole"/>
        <partnerLink name="NhincConnectionMgrPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" partnerLinkType="tns:NhincComponentConnectionManager" partnerRole="NhincComponentConnectionManagerPortTypeRole"/>
        <partnerLink name="NhincInternalPolicyEngineFacadaPL" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" partnerLinkType="tns:NhincComponentInternalPolicyEngineFacade" partnerRole="NhincComponentInternalPolicyEngineFacadePortTypeRole"/>
        <partnerLink name="AdapterReidentificationPL" xmlns:tns="urn:gov:hhs:fha:nhinc:adapterreidentification" partnerLinkType="tns:AdapterReidentification" partnerRole="AdapterReidentificationPortTypeRole"/>
        <partnerLink name="NhincSubDiscTransformsPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" partnerLinkType="tns:NhincComponentSubDiscTransforms" partnerRole="NhincComponentSubDiscTransformsPortTypeRole"/>
        <partnerLink name="NhincInternalSubDisc201309OrchPL" xmlns:tns="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" partnerLinkType="tns:NhincComponentInternalSubDiscovery201309Orch" myRole="NhincComponentInternalSubDiscovery201309OrchPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="GetRealIdentOut" xmlns:tns="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" messageType="tns:GetRealIdentResponseMessage"/>
        <variable name="GetRealIdentIn" xmlns:tns="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" messageType="tns:GetRealIdentRequestMessage"/>
        <variable name="GetConnectionInfoEndpointByServiceNameOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameResponseMessage"/>
        <variable name="GetConnectionInfoEndpointByServiceNameIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameRequestMessage"/>
        <variable name="GetHcidPropOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyResponseMessage"/>
        <variable name="GetHcidPropIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyRequestMessage"/>
        <variable name="CreateFault201310Out" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateFault201310ResponseMessage"/>
        <variable name="CreateFault201310In" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" messageType="tns:CreateFault201310RequestMessage"/>
        <variable name="GetAdapterReidentRealIdentifierOut" xmlns:tns="urn:gov:hhs:fha:nhinc:adapterreidentification" messageType="tns:GetRealIdentifierResponseMessage"/>
        <variable name="GetAdapterReidentRealIdentifierIn" xmlns:tns="urn:gov:hhs:fha:nhinc:adapterreidentification" messageType="tns:GetRealIdentifierRequestMessage"/>
        <variable name="CheckPolicySubjectReidentificationOut" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" messageType="tns:CheckPolicyResponseMessage"/>
        <variable name="CheckPolicySubjectReidentificationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" messageType="tns:CheckPolicySubjectReidentificationRequestMessage"/>
    </variables>
    <sequence>
        <receive name="ReceiveGetRealId" createInstance="yes" partnerLink="NhincInternalSubDisc201309OrchPL" operation="GetRealIdent" xmlns:tns="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" portType="tns:NhincComponentInternalSubDiscovery201309OrchPortType" variable="GetRealIdentIn"/>
        <assign name="AssignCheckPolicy201309">
            <copy>
                <from>'Outbound'</from>
                <to>$CheckPolicySubjectReidentificationIn.CheckPolicySubjectReidentificationRequest/ncevent:direction</to>
            </copy>
            <copy>
                <from>'Nhin'</from>
                <to>$CheckPolicySubjectReidentificationIn.CheckPolicySubjectReidentificationRequest/ncevent:interface</to>
            </copy>
            <copy>
                <from variable="GetRealIdentIn" part="GetRealIdentRequest"/>
                <to>$CheckPolicySubjectReidentificationIn.CheckPolicySubjectReidentificationRequest/ncevent:message</to>
            </copy>
        </assign>
        <invoke name="InvokeCheckPolicy201309" partnerLink="NhincInternalPolicyEngineFacadaPL" operation="CheckPolicySubjectReidentification" xmlns:tns="urn:gov:hhs:fha:nhinc:NhincComponentInternalPolicyEngineFacade" portType="tns:NhincComponentInternalPolicyEngineFacadePortType" inputVariable="CheckPolicySubjectReidentificationIn" outputVariable="CheckPolicySubjectReidentificationOut"/>
        <if name="IfPermit">
            <condition>'Permit' = $CheckPolicySubjectReidentificationOut.CheckPolicyResponse/nccommadapt:response/oasis:Result/oasis:Decision</condition>
            <sequence name="InvokeAdapterReidentSeq">
                <assign name="AssignGetHomeCommunityId">
                    <copy>
                        <from>'gateway'</from>
                        <to>$GetHcidPropIn.GetPropertyRequest/propacc:propertyFile</to>
                    </copy>
                    <copy>
                        <from>'localHomeCommunityId'</from>
                        <to>$GetHcidPropIn.GetPropertyRequest/propacc:propertyName</to>
                    </copy>
                </assign>
                <invoke name="InvokeGetHomeCommunityId" partnerLink="NhincPropAccessorPL" operation="GetProperty" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" portType="tns:NhincComponentPropAccessorPortType" inputVariable="GetHcidPropIn" outputVariable="GetHcidPropOut"/>
                <assign name="AssignReidentEPR">
                    <copy>
                        <from>'adapterreidentificationservice'</from>
                        <to>$GetConnectionInfoEndpointByServiceNameIn.GetConnectionInfoEndpointByServiceNameRequest/ns0:homeCommunityWithServiceName/ns0:serviceName</to>
                    </copy>
                    <copy>
                        <from>$GetHcidPropOut.GetPropertyResponse/propacc:propertyValue</from>
                        <to>$GetConnectionInfoEndpointByServiceNameIn.GetConnectionInfoEndpointByServiceNameRequest/ns0:homeCommunityWithServiceName/ns0:homeCommunity/ns2:homeCommunityId</to>
                    </copy>
                </assign>
                <invoke name="InvokeGetReidentEPR" partnerLink="NhincConnectionMgrPL" operation="GetConnectionInfoEndpointByServiceName" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoEndpointByServiceNameIn" outputVariable="GetConnectionInfoEndpointByServiceNameOut"/>
                <assign name="Assign201309Response">
                    <sxt:trace>
                        <sxt:log level="info" location="onStart">
                            <ns3:from>'Invoke Adapter Reidentification'</ns3:from>
                        </sxt:log>
                        <sxt:log level="info" location="onStart">
                            <ns3:from variable="GetConnectionInfoEndpointByServiceNameOut" part="ConnectionInfoEndpoint"/>
                        </sxt:log>
                        <sxt:log level="info" location="onComplete">
                            <ns3:from variable="GetAdapterReidentRealIdentifierIn" part="GetRealIdentifierRequest"/>
                        </sxt:log>
                    </sxt:trace>
                    <copy>
                        <from>ns3:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoEndpointByServiceNameOut.ConnectionInfoEndpoint/ns0:serviceConnectionInfoEndpoints/ns0:serviceConnectionInfoEndpoint/ns2:EPR/ns2:EndpointReference)</from>
                        <to partnerLink="AdapterReidentificationPL"/>
                    </copy>
                    <copy>
                        <from variable="GetRealIdentIn" part="GetRealIdentRequest"/>
                        <to variable="GetAdapterReidentRealIdentifierIn" part="GetRealIdentifierRequest"/>
                    </copy>
                </assign>
                <invoke name="InvokeAdapterReidentification" partnerLink="AdapterReidentificationPL" operation="GetRealIdentifier" xmlns:tns="urn:gov:hhs:fha:nhinc:adapterreidentification" portType="tns:AdapterReidentificationPortType" inputVariable="GetAdapterReidentRealIdentifierIn" outputVariable="GetAdapterReidentRealIdentifierOut"/>
                <assign name="Assign201310Response">
                    <copy>
                        <from variable="GetAdapterReidentRealIdentifierOut" part="GetRealIdentifierResponse"/>
                        <to variable="GetRealIdentOut" part="GetRealIdentResponse"/>
                    </copy>
                </assign>
            </sequence>
            <else>
                <sequence>
                    <assign name="AssignCreateFault201310">
                        <copy>
                            <from>$GetRealIdentIn.GetRealIdentRequest/hl7:PRPA_IN201309UV/hl7:receiver/hl7:device/hl7:id/@root</from>
                            <to>$CreateFault201310In.CreateFault201310Request/hl7:senderOID</to>
                        </copy>
                        <copy>
                            <from>$GetRealIdentIn.GetRealIdentRequest/hl7:PRPA_IN201309UV/hl7:sender/hl7:device/hl7:id/@root</from>
                            <to>$CreateFault201310In.CreateFault201310Request/hl7:receiverOID</to>
                        </copy>
                    </assign>
                    <invoke name="InvokeCreateFault" partnerLink="NhincSubDiscTransformsPL" operation="CreateFault201310" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubdisctransforms" portType="tns:NhincComponentSubDiscTransformsPortType" inputVariable="CreateFault201310In" outputVariable="CreateFault201310Out"/>
                    <assign name="Assign201310Fault">
                        <copy>
                            <from variable="CreateFault201310Out" part="CreateFault201310Response"/>
                            <to>$GetRealIdentOut.GetRealIdentResponse/hl7:PRPA_IN201310UV</to>
                        </copy>
                    </assign>
                </sequence>
            </else>
        </if>
        <reply name="Reply201309Response" partnerLink="NhincInternalSubDisc201309OrchPL" operation="GetRealIdent" xmlns:tns="http://j2ee.netbeans.org/wsdl/Interfaces/NhincComponentInternalSubDiscovery201309Orch" portType="tns:NhincComponentInternalSubDiscovery201309OrchPortType" variable="GetRealIdentOut"/>
    </sequence>
</process>
