<?xml version="1.0" encoding="UTF-8"?>
<process
    name="EntityComponentInternalNotifyOrch"
    targetNamespace="urn:gov:hhs:fha:nhinc:gateway:entityinternalorchbpel:entitycomponentinternalnotifyorch"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="urn:gov:hhs:fha:nhinc:gateway:entityinternalorchbpel:entitycomponentinternalnotifyorch" 
    xmlns:nccommon="urn:gov:hhs:fha:nhinc:common:nhinccommon" 
    xmlns:nccommonentity="urn:gov:hhs:fha:nhinc:common:nhinccommonentity" 
    xmlns:nccommonsubcdc="urn:gov:hhs:fha:nhinc:common:subscriptionb2overridefordocuments" 
    xmlns:rim="urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0" 
    xmlns:subdte="urn:gov:hhs:fha:nhinc:common:subscriptiondte" 
    xmlns:nccommonsub="urn:gov:hhs:fha:nhinc:common:subscription" 
    xmlns:wsnt="http://docs.oasis-open.org/wsn/b-2" 
    xmlns:nccommonproxy="urn:gov:hhs:fha:nhinc:common:nhinccommonproxy">
    <import namespace="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" location="Interfaces/wsdl/EntityComponentInternalNotifyOrch.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhincproxynotificationconsumer" location="Interfaces/wsdl/NhincProxyNotificationConsumer.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" location="Interfaces/wsdl/NhincComponentInternalSubscriptionDte.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentsubscriptionrepository" location="Interfaces/wsdl/NhincComponentSubscriptionRepository.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="SubscriptionDtePL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" partnerLinkType="tns:NhincComponentInternalSubscriptionDte" partnerRole="NhincComponentInternalSubscriptionDtePortTypeRole"/>
        <partnerLink name="SubscriptionRepoPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubscriptionrepository" partnerLinkType="tns:NhincComponentSubscriptionRepository" partnerRole="NhincComponentSubscriptionRepositoryPortTypeRole"/>
        <partnerLink name="NhincNotifyProxyPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxynotificationconsumer" partnerLinkType="tns:NhincProxyNotificationConsumer" partnerRole="NhincProxyNotificationConsumerPortTypeRole"/>
        <partnerLink name="EntityNotifyPL" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" partnerLinkType="tns:EntityComponentInternalNotifyOrch" myRole="EntityComponentInternalNotifyOrchPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="DocumentNotifyIn" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" messageType="tns:DocumentNotifyRequestMessage"/>
    </variables>
    <sequence>
        <receive name="ReceiveEntityNotify" createInstance="yes" partnerLink="EntityNotifyPL" operation="DocumentNotify" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" portType="tns:EntityComponentInternalNotifyOrchPortType" variable="DocumentNotifyIn"/>
        <scope name="ProcessDocumentNotifyScope">
            <variables>
                <variable name="DocumentNotifyOut" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" messageType="tns:DocumentNotifyResponseMessage"/>
            </variables>
            <faultHandlers>
                <catch faultName="sxeh:systemFault" faultVariable="systemFaultVar" faultMessageType="sxeh:faultMessage">
                    <sequence name="SystemFaultDocNotifySeq">
                        <assign name="AssignDocNotifyFault">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'EntityComponentInternalNotifyOrch.bpel - A system fault was encounterd processing a Document Notify message. Fault detials follow...'</from>
                                </sxt:log>
                                <sxt:log level="warning" location="onStart">
                                    <from variable="systemFaultVar"/>
                                </sxt:log>
                            </sxt:trace>
                            <copy>
                                <from>'Internal Gateway Error'</from>
                                <to>$DocumentNotifyOut.DocumentNotifyResponse/nccommon:message</to>
                            </copy>
                        </assign>
                        <reply name="ReplyDocNotifyFault" partnerLink="EntityNotifyPL" operation="DocumentNotify" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" portType="tns:EntityComponentInternalNotifyOrchPortType" variable="DocumentNotifyOut"/>
                    </sequence>
                </catch>
            </faultHandlers>
            <sequence name="ProcessDocumentNotifySeq">
                <forEach name="ForEachNotificationMessage" parallel="no" counterName="NotifyMsgCtr">
                    <startCounterValue>1</startCounterValue>
                    <finalCounterValue>count($DocumentNotifyIn.DocumentNotifyRequest/nccommonentity:notify/nccommonsubcdc:NotificationMessage)</finalCounterValue>
                    <scope name="ProcessNotifyMessageScope">
                        <variables>
                            <variable name="RetrieveByCriteriaOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubscriptionrepository" messageType="tns:RetrieveByCriteriaResponse"/>
                            <variable name="RetrieveByCriteriaIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubscriptionrepository" messageType="tns:RetrieveByCriteriaRequest"/>
                            <variable name="CreateSubscriptionCriteriaOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" messageType="tns:TransformEntityNotifyDocumentToSubscriptionCriteriaResponseMessage"/>
                            <variable name="CreateSubscriptionCriteriaIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" messageType="tns:TransformEntityNotifyDocumentToSubscriptionCriteriaRequestMessage"/>
                        </variables>
                        <sequence name="ProcessNotifyMessageSeq">
                            <assign name="AssignCreateSubscriptionCriteria">
                                <copy>
                                    <from>$DocumentNotifyIn.DocumentNotifyRequest/rim:RegistryObjectList</from>
                                    <to>$CreateSubscriptionCriteriaIn.TransformEntityNotifyDocumentToSubscriptionCriteria/subdte:RegistryObjectList</to>
                                </copy>
                                <copy>
                                    <from>$DocumentNotifyIn.DocumentNotifyRequest/nccommonentity:notify/nccommonsubcdc:NotificationMessage[$NotifyMsgCtr]</from>
                                    <to>$CreateSubscriptionCriteriaIn.TransformEntityNotifyDocumentToSubscriptionCriteria/subdte:NotifyDocument/nccommonsubcdc:NotificationMessage</to>
                                </copy>
                            </assign>
                            <invoke name="InvokeCreateSubscriptionCriteria" partnerLink="SubscriptionDtePL" operation="TransformEntityNotifyDocumentToSubscriptionCriteria" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" portType="tns:NhincComponentInternalSubscriptionDtePortType" inputVariable="CreateSubscriptionCriteriaIn" outputVariable="CreateSubscriptionCriteriaOut"/>
                            <assign name="AssignSubscriptionLookup">
                                <copy>
                                    <from>$CreateSubscriptionCriteriaOut.TransformEntityNotifyDocumentToSubscriptionCriteria/nccommonsub:SubscriptionCriteria</from>
                                    <to variable="RetrieveByCriteriaIn" part="subscriptionCriteria"/>
                                </copy>
                            </assign>
                            <invoke name="InvokeSubscriptionLookup" partnerLink="SubscriptionRepoPL" operation="RetrieveByCriteria" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentsubscriptionrepository" portType="tns:NhincComponentSubscriptionRepositoryPortType" inputVariable="RetrieveByCriteriaIn" outputVariable="RetrieveByCriteriaOut"/>
                            <forEach name="ForEachSubscription" parallel="no" counterName="SubItemCtr">
                                <startCounterValue>1</startCounterValue>
                                <finalCounterValue>count($RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem)</finalCounterValue>
                                <scope name="ProcessSubItemScope">
                                    <variables>
                                        <variable name="CreateNhinNotifyDocumentOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" messageType="tns:CreateNhinNotifyDocumentResponseMessage"/>
                                        <variable name="CreateNhinNotifyDocumentIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" messageType="tns:CreateNhinNotifyDocumentRequestMessage"/>
                                        <variable name="NotifyIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxynotificationconsumer" messageType="tns:NotifyRequestMessage"/>
                                    </variables>
                                    <sequence name="ProcessSubItemSeq">
                                        <assign name="AssignCreateNhinNotify">
                                            <copy>
                                                <from>$RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem[$SubItemCtr]
                                                    <sxed:editor>
                                                        <sxed:predicate path="$RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem[$SubItemCtr]" source="from"/>
                                                    </sxed:editor>
                                                </from>
                                                <to>$CreateNhinNotifyDocumentIn.CreateNhinNotifyDocumentRequest/nccommonsub:SubscriptionItem</to>
                                            </copy>
                                            <copy>
                                                <from>$DocumentNotifyIn.DocumentNotifyRequest/nccommonentity:notify</from>
                                                <to>$CreateNhinNotifyDocumentIn.CreateNhinNotifyDocumentRequest/subdte:notify</to>
                                            </copy>
                                        </assign>
                                        <invoke name="InvokeCreateNhinNotify" partnerLink="SubscriptionDtePL" operation="CreateNhinNotifyDocument" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincinternalcomponentpolicyenginetransform" portType="tns:NhincComponentInternalSubscriptionDtePortType" inputVariable="CreateNhinNotifyDocumentIn" outputVariable="CreateNhinNotifyDocumentOut"/>
                                        <empty name="Policy_Placeholder"/>
                                        <assign name="AssignNotifyProxy">
                                            <copy>
                                                <from>$DocumentNotifyIn.DocumentNotifyRequest/nccommonentity:assertion</from>
                                                <to>$NotifyIn.NotifyRequest/nccommonproxy:assertion</to>
                                            </copy>
                                            <copy>
                                                <from>$RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem[$SubItemCtr]/nccommonsub:Subscriber/nccommonsub:NotificationConsumerEndpointAddress</from>
                                                <to>$NotifyIn.NotifyRequest/nccommonproxy:nhinTargetSystem/nccommon:url</to>
                                            </copy>
                                            <copy>
                                                <from>$RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem[$SubItemCtr]/nccommonsub:SubscriptionCriteria/nccommonsub:SubscribeePatient/nccommon:SubjectIdentifier</from>
                                                <to>$NotifyIn.NotifyRequest/nccommonproxy:assertion/nccommon:uniquePatientId</to>
                                            </copy>
                                            <copy>
                                                <from>$RetrieveByCriteriaOut.subscriptionItems/nccommonsub:subscriptionItem[$SubItemCtr]/nccommonsub:Subscribee/nccommonsub:Community/nccommonsub:Id</from>
                                                <to>$NotifyIn.NotifyRequest/nccommonproxy:assertion/nccommon:userInfo/nccommon:org/nccommon:homeCommunityId</to>
                                            </copy>
                                            <copy>
                                                <from>$CreateNhinNotifyDocumentOut.CreateNhinNotifyDocumentResponse/wsnt:Notify/wsnt:NotificationMessage</from>
                                                <to>$NotifyIn.NotifyRequest/wsnt:Notify/wsnt:NotificationMessage</to>
                                            </copy>
                                        </assign>
                                        <invoke name="InvokeNotifyProxy" partnerLink="NhincNotifyProxyPL" operation="Notify" xmlns:tns="urn:gov:hhs:fha:nhinc:nhincproxynotificationconsumer" portType="tns:NhincProxyNotificationConsumerPortType" inputVariable="NotifyIn"/>
                                    </sequence>
                                </scope>
                            </forEach>
                        </sequence>
                    </scope>
                </forEach>
                <assign name="AssignEntityNotifyResp">
                    <copy>
                        <from>'Successfully processed document notify message'</from>
                        <to>$DocumentNotifyOut.DocumentNotifyResponse/nccommon:message</to>
                    </copy>
                </assign>
                <reply name="ReplyEntityNotify" partnerLink="EntityNotifyPL" operation="DocumentNotify" xmlns:tns="urn:gov:hhs:fha:nhinc:entitycomponentinternalnotifyorch" portType="tns:EntityComponentInternalNotifyOrchPortType" variable="DocumentNotifyOut"/>
            </sequence>
        </scope>
    </sequence>
</process>
