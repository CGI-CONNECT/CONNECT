<?xml version="1.0" encoding="UTF-8"?>
<process
    name="PatientCorrelationFacadeBpel"
    targetNamespace="urn:gov:hhs:fha:nhinc:common:patientcorrelationfacade:bpel"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:bpelexec="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="urn:gov:hhs:fha:nhinc:common:patientcorrelationfacade:bpel" 
    xmlns:pcf="urn:gov:hhs:fha:nhinc:common:patientcorrelationfacade" 
    xmlns:nccommon="urn:gov:hhs:fha:nhinc:common:nhinccommon"
    xmlns:hl7="urn:hl7-org:v3"
    xmlns:cm="urn:gov:hhs:fha:nhinc:common:connectionmanagerinfo" 
    xmlns:prop="urn:gov:hhs:fha:nhinc:common:propertyaccess" 
    >
    <import namespace="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" location="Interfaces/wsdl/NhincComponentPatientCorrelationFacade.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" location="Interfaces/wsdl/NhincComponentPatientCorrelation.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" location="Interfaces/wsdl/NhincComponentPatientCorrelationFacadeDte.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" location="Interfaces/wsdl/NhincComponentPropAccessor.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" location="Interfaces/wsdl/NhincComponentConnectionManager.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="PatientCorrelationPartnerLink" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" partnerLinkType="tns:PatientCorrelation" partnerRole="PatientCorrelationPortTypeRole"/>
        <partnerLink name="DtePartnerLink" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" partnerLinkType="tns:NhincComponentPatientCorrelationFacadeDte2" partnerRole="PatientCorrelationFacadeDteRole"/>
        <partnerLink name="PropertyAccessorPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" partnerLinkType="tns:NhincComponentPropAccessor" partnerRole="NhincComponentPropAccessorPortTypeRole"/>
        <partnerLink name="ConnectionManagerPL" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" partnerLinkType="tns:NhincComponentConnectionManager" partnerRole="NhincComponentConnectionManagerPortTypeRole"/>
        <partnerLink name="PatientCorrelationFacadePartnerLink" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" partnerLinkType="tns:PatientCorrelationFacadePartnerLinkType" myRole="PatientCorrelationPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="HomeCommunityId" type="xsd:string"/>
        <variable name="GetPropertyOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyResponseMessage"/>
        <variable name="GetPropertyIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyRequestMessage"/>
        <variable name="GetConnectionInfoOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameResponseMessage"/>
        <variable name="GetConnectionInfoIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" messageType="tns:GetConnectionInfoEndpointByServiceNameRequestMessage"/>
        <variable name="FacadeRetrievePatientCorrelationsIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:RetrievePatientCorrelationsRequestMessage"/>
        <variable name="FacadeAddPatientCorrelationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:AddPatientCorrelationRequestMessage"/>
        <variable name="FacadeRemovePatientCorrelationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:RemovePatientCorrelationRequestMessage"/>
    </variables>
    <sequence>
        <pick name="PickInputMessage" createInstance="yes">
            <onMessage partnerLink="PatientCorrelationFacadePartnerLink" operation="RetrievePatientCorrelations" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" portType="tns:PatientCorrelationFacadePortType" variable="FacadeRetrievePatientCorrelationsIn">
                <scope name="RetrieveScope">
                    <variables>
                        <variable name="GetPropertyOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyResponseMessage"/>
                        <variable name="GetPropertyIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" messageType="tns:GetPropertyRequestMessage"/>
                        <variable name="CreateFacadeRetrieveResultIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateFacadeRetrieveResultRequestMessage"/>
                        <variable name="CreateFacadeRetrieveResultOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateFacadeRetrieveResultResponseMessage"/>
                        <variable name="PixRetrievePatientCorrelationsIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:RetrievePatientCorrelationsRequestMessage"/>
                        <variable name="PixRetrievePatientCorrelationsOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:RetrievePatientCorrelationsResponseMessage"/>
                        <variable name="CreatePixRetrieveIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRetrieveRequestMessage"/>
                        <variable name="CreatePixRetrieveOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRetrieveResponseMessage"/>
                        <variable name="RetrievePatientCorrelationsOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:RetrievePatientCorrelationsResponseMessage"/>
                    </variables>
                    <sequence name="RetrieveSeq">
                        <assign name="RetrieveSeq-AssignInputToBuildPixRetrieve">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'begin RetrieveSeq'</from>
                                </sxt:log>
                            </sxt:trace>
                            <copy>
                                <from>$FacadeRetrievePatientCorrelationsIn.RetrievePatientCorrelationsRequest</from>
                                <to>$CreatePixRetrieveIn.CreatePixRetrieveRequest/pcf:RetrievePatientCorrelationsRequest</to>
                            </copy>
                        </assign>
                        <invoke name="RetrieveSeq-InvokeDteToFormPixRetrieve" partnerLink="DtePartnerLink" operation="CreatePixRetrieve" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreatePixRetrieveIn" outputVariable="CreatePixRetrieveOut"/>
                        <assign name="RetrieveSeq-AssignRetrieveInput">
                            <copy>
                                <from>$CreatePixRetrieveOut.CreatePixRetrieveResponse/hl7:PRPA_IN201309UV</from>
                                <to>$PixRetrievePatientCorrelationsIn.RetrievePatientCorrelationsRequest/hl7:PRPA_IN201309UV</to>
                            </copy>
                        </assign>
                        <assign name="RetrieveSeq-AssignInputToLookupHomeCommunity">
                             <copy>
                                <from>'gateway'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyFile</to>
                            </copy>
                            <copy>
                                <from>'localHomeCommunityId'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyName</to>
                            </copy>
                        </assign>
                        <invoke name="RetrieveSeq-InvokePropertiesGetHomeCommunity" partnerLink="PropertyAccessorPL" operation="GetProperty" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" portType="tns:NhincComponentPropAccessorPortType" inputVariable="GetPropertyIn" outputVariable="GetPropertyOut">
                        <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke RetrieveSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetPropertyIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End RetrieveSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetPropertyOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="RetrieveSeq-AssignHomeCommunity">
                            <copy>
                                <from>$GetPropertyOut.GetPropertyResponse/prop:propertyValue</from>
                                <to variable="HomeCommunityId"/>
                            </copy>
                        </assign>
                        <assign name="RetrieveSeq-AssignInputConnectionManagerForPix">
                            <copy>
                                <from>'patientcorrelation'</from>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:serviceName</to>
                            </copy>
                            <copy>
                                <from variable="HomeCommunityId"/>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:homeCommunity/nccommon:homeCommunityId</to>
                            </copy>
                        </assign>
                        <invoke name="RetrieveSeq-InvokeConnectionManagerForPix" partnerLink="ConnectionManagerPL" operation="GetConnectionInfoEndpointByServiceName" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoIn" outputVariable="GetConnectionInfoOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke RetrieveSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetConnectionInfoIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End RetrieveSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetConnectionInfoOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="RetrieveSeq-AssignPixEndpoint">
                            <copy>
                                <from>bpelexec:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoOut.ConnectionInfoEndpoint/cm:serviceConnectionInfoEndpoints/cm:serviceConnectionInfoEndpoint/nccommon:EPR/nccommon:EndpointReference)</from>
                                <to partnerLink="PatientCorrelationPartnerLink"/>
                            </copy>
                        </assign>
                        <invoke name="RetrieveSeq-InvokePatientCorrelationRetrieve" partnerLink="PatientCorrelationPartnerLink" operation="RetrievePatientCorrelations" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" portType="tns:PatientCorrelationPortType" inputVariable="PixRetrievePatientCorrelationsIn" outputVariable="PixRetrievePatientCorrelationsOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke RetrieveSeq-InvokePatientCorrelationRetrieve'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="PixRetrievePatientCorrelationsIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End RetrieveSeq-InvokePatientCorrelationRetrieve'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="PixRetrievePatientCorrelationsOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="RetrieveSeq-AssignInputToBuildAck">
                            <copy>
                                <from>$PixRetrievePatientCorrelationsOut.RetrievePatientCorrelationsResponse/hl7:PRPA_IN201310UV</from>
                                <to>$CreateFacadeRetrieveResultIn.CreateFacadeRetrieveResultRequest/hl7:PRPA_IN201310UV</to>
                            </copy>
                        </assign>
                        <invoke name="RetrieveSeq-InvokeDteToBuildResponse" partnerLink="DtePartnerLink" operation="CreateFacadeRetrieveResult" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreateFacadeRetrieveResultIn" outputVariable="CreateFacadeRetrieveResultOut"/>
                        <assign name="Retrieve-AssignReply">
                            <copy>
                                <from>$CreateFacadeRetrieveResultOut.CreateFacadeRetrieveResultResponse/pcf:RetrievePatientCorrelationsResponse</from>
                                <to variable="RetrievePatientCorrelationsOut" part="RetrievePatientCorrelationsResponse"/>
                            </copy>
                        </assign>
                        <reply name="Retrieve-Reply" partnerLink="PatientCorrelationFacadePartnerLink" operation="RetrievePatientCorrelations" portType="tns:PatientCorrelationFacadePortType" variable="RetrievePatientCorrelationsOut"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="PatientCorrelationFacadePartnerLink" operation="AddPatientCorrelation" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" portType="tns:PatientCorrelationFacadePortType" variable="FacadeAddPatientCorrelationIn">
                <scope name="AddScope">
                    <variables>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="PixAddPatientCorrelationOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:AddPatientCorrelationResponseMessage"/>
                        <variable name="PixAddPatientCorrelationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:AddPatientCorrelationRequestMessage"/>
                        <variable name="CreateBuildPixAddOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixAddResponseMessage"/>
                        <variable name="CreateBuildPixAddIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixAddRequestMessage"/>
                        <variable name="FacadeAddPatientCorrelationOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" messageType="tns:AddPatientCorrelationResponseMessage"/>
                        <variable name="CreatePixAddOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixAddResponseMessage"/>
                        <variable name="CreatePixAddIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixAddRequestMessage"/>
                        <variable name="CreatePixRetrieveOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRetrieveResponseMessage"/>
                        <variable name="CreatePixRetrieveIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRetrieveRequestMessage"/>
                    </variables>
                    <sequence name="AddSeq">
                        <assign name="AddSeq-AssignInputToBuildPixAdd">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'begin AddSequence'</from>                                    
                                </sxt:log>
                            </sxt:trace>
                            <copy>
                                <from variable="FacadeAddPatientCorrelationIn" part="AddPatientCorrelationRequest"/>
                                <to>$CreateBuildPixAddIn.CreatePixAddRequest/pcf:AddPatientCorrelationRequest</to>
                            </copy>
                        </assign>
                        <invoke name="InvokeDteToFormPixAdd" partnerLink="DtePartnerLink" operation="CreatePixAdd" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreateBuildPixAddIn" outputVariable="CreateBuildPixAddOut"/>
                        <assign name="AddSeq-AssignPixAddInput">
                            <copy>
                                <from>$CreateBuildPixAddOut.CreatePixAddResponse/hl7:PRPA_IN201301UV</from>
                                <to>$PixAddPatientCorrelationIn.AddPatientCorrelationRequest/hl7:PRPA_IN201301UV</to>
                            </copy>
                        </assign>
                        <assign name="AddSeq-AssignInputToLookupHomeCommunity">
                             <copy>
                                <from>'gateway'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyFile</to>
                            </copy>
                            <copy>
                                <from>'localHomeCommunityId'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyName</to>
                            </copy>
                        </assign>
                        <invoke name="AddSeq-InvokePropertiesGetHomeCommunity" partnerLink="PropertyAccessorPL" operation="GetProperty" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" portType="tns:NhincComponentPropAccessorPortType" inputVariable="GetPropertyIn" outputVariable="GetPropertyOut">
                        <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke AddSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetPropertyIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End AddSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetPropertyOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="AddSeq-AssignHomeCommunity">
                            <copy>
                                <from>$GetPropertyOut.GetPropertyResponse/prop:propertyValue</from>
                                <to variable="HomeCommunityId"/>
                            </copy>
                        </assign>
                        <assign name="AddSeq-AssignInputConnectionManagerForPix">
                            <copy>
                                <from>'patientcorrelation'</from>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:serviceName</to>
                            </copy>
                            <copy>
                                <from variable="HomeCommunityId"/>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:homeCommunity/nccommon:homeCommunityId</to>
                            </copy>
                        </assign>
                        <invoke name="AddSeq-InvokeConnectionManagerForPix" partnerLink="ConnectionManagerPL" operation="GetConnectionInfoEndpointByServiceName" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoIn" outputVariable="GetConnectionInfoOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke AddSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetConnectionInfoIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End AddSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetConnectionInfoOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="AddSeq-AssignPixEndpoint">
                            <copy>
                                <from>bpelexec:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoOut.ConnectionInfoEndpoint/cm:serviceConnectionInfoEndpoints/cm:serviceConnectionInfoEndpoint/nccommon:EPR/nccommon:EndpointReference)</from>
                                <to partnerLink="PatientCorrelationPartnerLink"/>
                            </copy>
                        </assign>
                        <invoke name="AddSeq-InvokePixAdd" partnerLink="PatientCorrelationPartnerLink" operation="AddPatientCorrelation" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" portType="tns:PatientCorrelationPortType" inputVariable="PixAddPatientCorrelationIn" outputVariable="PixAddPatientCorrelationOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke AddSeq-InvokePixAdd'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="PixAddPatientCorrelationIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End AddSeq-InvokePixAdd'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="PixAddPatientCorrelationOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="AddSeq-AssignInputToBuildAck">
                            <copy>
                                <from>'success'</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:message</to>
                            </copy>
                        </assign>
                        <invoke name="AddSeq-InvokeBuildAck" partnerLink="DtePartnerLink" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreateAckIn" outputVariable="CreateAckOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke AddSeq-InvokeBuildAck'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="CreateAckIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End invoke AddSeq-InvokeBuildAck'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="CreateAckOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="Add-AssignReply">
                            <copy>
                                <from>$CreateAckOut.CreateAckResponse/nccommon:Acknowledgement</from>
                                <to variable="FacadeAddPatientCorrelationOut" part="ack"/>
                            </copy>
                        </assign>
                        <reply name="Add-Reply" partnerLink="PatientCorrelationFacadePartnerLink" operation="AddPatientCorrelation" portType="tns:PatientCorrelationFacadePortType" variable="FacadeAddPatientCorrelationOut"/>
                    </sequence>
                </scope>
            </onMessage>
            <onMessage partnerLink="PatientCorrelationFacadePartnerLink" operation="RemovePatientCorrelation" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacade" portType="tns:PatientCorrelationFacadePortType" variable="FacadeRemovePatientCorrelationIn">
                <scope name="RevokeScope">
                    <variables>
                        <variable name="FacadeRemovePatientCorrelationOut" messageType="tns:RemovePatientCorrelationResponseMessage"/>
                        <variable name="CreateAckOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateAckResponseMessage"/>
                        <variable name="CreateAckIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreateAckRequestMessage"/>
                        <variable name="CreatePixRevokeOut" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRevokeResponseMessage"/>
                        <variable name="CreatePixRevokeIn" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" messageType="tns:CreatePixRevokeRequestMessage"/>
                        <variable name="RemovePatientCorrelationOut" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:RemovePatientCorrelationResponseMessage"/>
                        <variable name="RemovePatientCorrelationIn" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" messageType="tns:RemovePatientCorrelationRequestMessage"/>
                    </variables>
                    <sequence name="RevokeSeq">
                        <assign name="RevokeSeq-AssignInputToBuildPixRevoke">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'begin RevokeSeq'</from>
                                </sxt:log>
                            </sxt:trace>
                            <copy>
                                <from variable="FacadeRemovePatientCorrelationIn" part="RemovePatientCorrelationRequest"/>
                                <to>$CreatePixRevokeIn.CreatePixRevokeRequest/pcf:RemovePatientCorrelationRequest</to>
                            </copy>
                        </assign>
                        <invoke name="RevokeSeq-InvokeDteToBuildPixRevoke" partnerLink="DtePartnerLink" operation="CreatePixRevoke" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreatePixRevokeIn" outputVariable="CreatePixRevokeOut"/>
                        <assign name="RevokeSeq-AssignInputToInvokePix">
                            <copy>
                                <from>$CreatePixRevokeOut.CreatePixRevokeResponse/hl7:PRPA_IN201303UV</from>
                                <to>$RemovePatientCorrelationIn.RemovePatientCorrelationRequest/hl7:PRPA_IN201303UV</to>
                            </copy>
                        </assign>
                        <assign name="RevokeSeq-AssignInputToLookupHomeCommunity">
                             <copy>
                                <from>'gateway'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyFile</to>
                            </copy>
                            <copy>
                                <from>'localHomeCommunityId'</from>
                                <to>$GetPropertyIn.GetPropertyRequest/prop:propertyName</to>
                            </copy>
                        </assign>
                        <invoke name="RevokeSeq-InvokePropertiesGetHomeCommunity" partnerLink="PropertyAccessorPL" operation="GetProperty" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpropaccessor" portType="tns:NhincComponentPropAccessorPortType" inputVariable="GetPropertyIn" outputVariable="GetPropertyOut">
                        <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke RevokeSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetPropertyIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End RevokeSeq-InvokePropertiesGetHomeCommunity'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetPropertyOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="RevokeSeq-AssignHomeCommunity">
                            <copy>
                                <from>$GetPropertyOut.GetPropertyResponse/prop:propertyValue</from>
                                <to variable="HomeCommunityId"/>
                            </copy>
                        </assign>
                        <assign name="RevokeSeq-AssignInputConnectionManagerForPix">
                            <copy>
                                <from>'patientcorrelation'</from>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:serviceName</to>
                            </copy>
                            <copy>
                                <from variable="HomeCommunityId"/>
                                <to>$GetConnectionInfoIn.GetConnectionInfoEndpointByServiceNameRequest/cm:homeCommunityWithServiceName/cm:homeCommunity/nccommon:homeCommunityId</to>
                            </copy>
                        </assign>
                        <invoke name="RevokeSeq-InvokeConnectionManagerForPix" partnerLink="ConnectionManagerPL" operation="GetConnectionInfoEndpointByServiceName" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentconnectionmanager" portType="tns:NhincComponentConnectionManagerPortType" inputVariable="GetConnectionInfoIn" outputVariable="GetConnectionInfoOut">
                            <sxt:trace>
                                <sxt:log level="info" location="onStart">
                                    <from>'Begin invoke RevokeSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onStart">
                                    <from variable="GetConnectionInfoIn"></from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from>'End RevokeSeq-InvokeConnectionManagerForPix'</from>
                                </sxt:log>
                                <sxt:log level="info" location="onComplete">
                                    <from variable="GetConnectionInfoOut"></from>
                                </sxt:log>
                            </sxt:trace>
                        </invoke>
                        <assign name="RevokeSeq-AssignPixEndpoint">
                            <copy>
                                <from>bpelexec:doXslTransform('urn:stylesheets:wrap2serviceref.xsl', $GetConnectionInfoOut.ConnectionInfoEndpoint/cm:serviceConnectionInfoEndpoints/cm:serviceConnectionInfoEndpoint/nccommon:EPR/nccommon:EndpointReference)</from>
                                <to partnerLink="PatientCorrelationPartnerLink"/>
                            </copy>
                        </assign>
                        <invoke name="RevokeSeq-InvokePixRevoke" partnerLink="PatientCorrelationPartnerLink" operation="RemovePatientCorrelation" xmlns:tns="urn:gov:hhs:fha:nhinc:nhinccomponentpatientcorrelation" portType="tns:PatientCorrelationPortType" inputVariable="RemovePatientCorrelationIn" outputVariable="RemovePatientCorrelationOut"/>
                        <assign name="RevokeSeq-AssiginInputToBuildAck">
                            <copy>
                                <from>'success'</from>
                                <to>$CreateAckIn.CreateAckRequest/hl7:message</to>
                            </copy>
                        </assign>
                        <invoke name="RevokeSeq-InvokeBuildAck" partnerLink="DtePartnerLink" operation="CreateAck" xmlns:tns="urn:gov:hhs:fha:nhinc:componentpatientcorrelationfacadedte" portType="tns:PatientCorrelationFacadeDte" inputVariable="CreateAckIn" outputVariable="CreateAckOut"/>
                        <assign name="RevokeSeq-AssignAck">
                            <copy>
                                <from>$CreateAckOut.CreateAckResponse/nccommon:Acknowledgement</from>
                                <to variable="FacadeRemovePatientCorrelationOut" part="ack"/>
                            </copy>
                        </assign>
                        <reply name="RevokeSeq-Reply" partnerLink="PatientCorrelationFacadePartnerLink" operation="RemovePatientCorrelation" portType="tns:PatientCorrelationFacadePortType" variable="FacadeRemovePatientCorrelationOut"/>
                    </sequence>
                </scope>
            </onMessage>
        </pick>
    </sequence>
</process>
